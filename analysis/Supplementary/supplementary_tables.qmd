---
title: "SOM result tables"
author:
  - Jane Doe:
      correspondence: "yes"
      email: janedoe@fosg.org
      orcid: 0000-0003-1689-0557
      institute:
        - fosg
        - fop
  - John Q. Doe:
      institute: fosg
      orcid: 0000-0003-1689-0558
  - Peder Ås:
      institute: fosg
      orcid: 0000-0003-1689-0559
  - Juan Pérez:
      orcid: 0000-0003-1689-0551
      institute:
        - name: Acme Corporation
  - Max Mustermann:
      orcid: 0000-0003-1689-0552
institute:
  - fosg:
      name: Formatting Open Science Group
      address: 23 Science Street, Eureka, Mississippi, USA
  - fop: Federation of Planets
title-block-published: "Last updated"  
date: now
date-format: long
format: 
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
execute:
  echo: false
  warning: false
  message: false
  comment: "#>"
  fig-path: "../figures/"
  fig-dpi: 600
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
bibliography: ../paper/references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
---

```{r}
#| label: library

library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(knitr)

```


```{r}
#| label: get-data

# Technological data
gravettian_tech <- read.csv(here::here('analysis/data/raw_data/VBT_6_7_JB.csv'))
proto_tech <- read.csv(here::here('analysis/data/raw_data/VBT_4E_5_JB.csv'))
solutrean_JC <- read.csv(here::here('analysis/data/raw_data/VBR_ABC_JC.csv'))
solutrean_points <- read.csv(here::here('analysis/data/raw_data/shelter_points_JC.csv'))

# RM data
shelter_RM <- read_csv(here::here('analysis/data/raw_data/MACRO_IND_SHELTER.csv')) # Shelter RM analysis
terrace_RM <- read_csv(here::here('analysis/data/raw_data/MACRO_IND_TERRACE.csv')) # Terrace RM analysis

# Context data
context <- read_csv(here::here('analysis/data/raw_data/VB_Terrace_context.csv')) # Terrace Field DB - lithic artefact info
xyz <- read_csv(here::here('analysis/data/raw_data/VB_Terrace_xyz.csv')) # Terrace Field DB - just coordinates

```

```{r}
#| label: databases-setup

# Terrace dataset setup
cols_to_concat_terrace <- c("UNIT", "ID")
context$ID <- str_squish(context$ID) # Remove empty spaces from ID field
xyz$ID <- str_squish(xyz$ID) # Remove empty spaces from UNIT field

proto_tech_WIP <- proto_tech %>%
  tidyr::unite(col='ID', all_of(cols_to_concat_terrace), sep="-", remove=TRUE) %>% 
  rename(CLASS = Class, COREPREPPROD = CorePreparProd, PIECECOMPLETENESS = PieceCompleteness, CORTEX = Cortex, CORTEXLOCATION = CortexLocation, PLATFORMTYPE = PlatformType, PLATFORMCORTEX = PlatformCortex, SCARCOUNT = ScarCount, THICKNESS = Thickness,
        MAXWIDTH = MaxWidth, LENGTH = Length, COREPLATFORM = CorePlatform, MAINFACECORTEX = MainFaceCortex, 
        MAINFACESCARCOUNT = MainFaceScarCount, COREABANDON = CoreAbandon, RETOUCHEDPIECETYPOLOGY = RetouchedPieceTypology) %>% 
  mutate(RETOUCHEDPIECETYPOLOGY = case_when(
    RETOUCHEDPIECETYPOLOGY == "Right truncation on retouched piece" ~ "Truncation",
    RETOUCHEDPIECETYPOLOGY == "Double backed bladelet" | RETOUCHEDPIECETYPOLOGY == "Backed bladelet parcial" ~ "Backed bladelet",
    RETOUCHEDPIECETYPOLOGY == "Dentilhado" ~ "Denticulate",
    RETOUCHEDPIECETYPOLOGY == "Burin on truncation" ~ "Burin",
    TRUE ~ RETOUCHEDPIECETYPOLOGY)) %>% 
  dplyr::select(ID, CLASS, COREPREPPROD, PIECECOMPLETENESS, CORTEX, CORTEXLOCATION, PLATFORMTYPE, PLATFORMCORTEX,
                SCARCOUNT, THICKNESS, MAXWIDTH, LENGTH, COREPLATFORM, MAINFACECORTEX, MAINFACESCARCOUNT, COREABANDON, RETOUCHEDPIECETYPOLOGY)

proto_original_chert <- proto_tech %>% 
  filter(RawMaterial %in% c("Chert", "Chalcedony"))

gravettian_tech <- gravettian_tech %>% 
  mutate(RETOUCHEDPIECETYPOLOGY = case_when(
    RETOUCHEDPIECETYPOLOGY == "Splintered piece with notch" | RETOUCHEDPIECETYPOLOGY == "Splintered piece with lateral retouch" ~ "Splintered piece",
    RETOUCHEDPIECETYPOLOGY == "Retouched flake siret fragment" | RETOUCHEDPIECETYPOLOGY == "Retouched flake frag" ~ "Retouched flake fragment",
    RETOUCHEDPIECETYPOLOGY == "Retouched bladelet frag" ~ "Retouched bladelet fragment",
    RETOUCHEDPIECETYPOLOGY == "Multiple burin" | RETOUCHEDPIECETYPOLOGY == "Burin splintered piece" | RETOUCHEDPIECETYPOLOGY == "Burin on truncation" ~ "Burin",
    RETOUCHEDPIECETYPOLOGY == "Double backed bladelet" ~ "Backed bladelet",
    TRUE ~ RETOUCHEDPIECETYPOLOGY)) %>% 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    TRUE ~ CLASS))

terrace_tech <- bind_rows(proto_tech_WIP, gravettian_tech)

terrace_RM_WIP <- terrace_RM %>%
  mutate(RMTYPE = case_when(
    RMTYPE == "Type 2" ~ "T2",
    RMTYPE == "Chalcedony" ~ "T1", # Altering first group names to final group names. Subtypes are maintained as before.
    RMTYPE == "TYPE 15" ~ "T3",
    RMTYPE == "TYPE 7" ~ "T4",
    RMTYPE == "TYPE 12" ~ "T5",
    RMTYPE == "TYPE 11" ~ "T6",
    RMTYPE == "TYPE 13" ~ "T7",
    RMTYPE == "TYPE 11F" ~ "T8",
    RMTYPE == "TYPE 13B" ~ "T9",
    RMTYPE == "Oolitic" ~ "T10",
    RMTYPE == "TYPE GB" ~ "T11",
    .default = RMTYPE)) %>% 
  select(AREA, ID, RMTYPE, SUBTYPE, WEIGHT, CORTEXTHICKNESS, CORTEXAPPEARANCE) %>%
  distinct(ID, .keep_all = TRUE)

context <- context %>%
  dplyr::rename("UNIT" = "Unit") %>% # Renaming first column from Unit to UNIT to use cols_to_concat
  unite(col='ID', cols_to_concat_terrace, sep="-", remove=FALSE) %>% # Unite UNIT with ID using cols_to_concat
  select(ID, Level, Spit, Code) %>% # Selecting important variables: ID refers to artifact ID; Level refers to archaeologycal layer; Spit refers to artificial levels within an archaeological layer; Code refers to type of artifact (e.g., LITHIC or BONE)
  distinct(ID, .keep_all = TRUE)

xyz <- xyz %>%
  unite(col='ID', cols_to_concat_terrace, sep="-", remove=FALSE) %>% # Unite UNIT with ID using cols_to_concat
  filter(Suffix == 0) %>% # To avoid several entries related to several points of the same artefact
  select(ID, X, Y, Z) %>% # Selecting important variables
  distinct(ID, .keep_all = TRUE)

field_data <- full_join(xyz, context, by = "ID") # Join field tables

terrace_tech_WIP <- left_join(terrace_tech, field_data, by = "ID") # Join field and RM type tables
terrace_dataset <- full_join(terrace_tech_WIP, terrace_RM_WIP, by = "ID") # Base 12690
terrace_dataset <- terrace_dataset %>%
  filter(!Level %in% c("3", "4", "4C", "4D")) %>%  # Dropping NAs on the technological class drops dataset to 1651
  drop_na(RMTYPE) %>%  # Dropping NAs on the RM database drops dataset to 3635
  drop_na(CLASS) # Dropping NAs on the technological class drops dataset to 1647
  
# Mutate level 5 to add phases: top of 5 (4E/5) and bottom of 5 (5), following Belmiro et al. (2020).
phase_dataset <- terrace_dataset |>
  mutate(Level = case_when(
    Level == 5 & Z > 24.1 ~ "4E/5",
    Level == 5 & Z < 24.1 ~ "5",
    Level == "7C" | Level == 8 ~ "7", # Collapsing samples from Level 7C and Level 8 into 7 to homogenise dataset
    TRUE ~ Level)) |> # Adding technocomplex name based on the levels
  mutate(Technocomplex = case_when(
    Level == "4E" | Level == "4E/5" | Level == 5 ~ "Proto-Solutrean",
    Level == 6 | Level == 7 ~ "Gravettian"))

# Shelter dataset setup
cols_to_concat_shelter <- c("YEAR", "ID") # Concatenate YEAR and ID variables in one single variable (e.g. 05-500)

solutrean_WIP <- solutrean_JC %>% 
  filter(Layer %in% c("A", "B", "C")) %>% # Filtering Solutrean layers
  filter(Raw.material %in% c("Chert", "Chalcedony")) %>% # Filtering raw materials
  filter(Screen != "Crivo") %>%  # Filtering out all bucket lithics since they were not included in the RM analysis
  mutate_at("Date", str_replace, "20", "") %>% # Removing initial part of the year to match IDs
  dplyr::rename("YEAR" = "Date") %>% 
  tidyr::unite(col='ID', all_of(cols_to_concat_shelter), sep="-", remove=FALSE) # Concatenate YEAR and ID variables in one single variable (e.g. 05-500)

# Dataset filtering for chert/chalcedony and levels (A-C), 3298 + 61 solutrean points, n=3359
solutrean_original_chert <- solutrean_JC %>% 
  filter(Layer %in% c("A", "B", "C")) %>% # Filtering Solutrean layers
  filter(Raw.material %in% c("Chert", "Chalcedony"))

# In Cascalheira 2010 Retouched piece was not a category but a variable. To match the other DBs, this category was added
solutrean_WIP <- solutrean_WIP %>% 
  mutate(Class = case_when( # This alteration is being done on the original class column
    Retouched == "Yes" ~ "Retouched piece", # Whenever retouch is present, class is now Retouched piece
    TRUE ~ Class)) %>% 
  mutate(CLASS = case_when( # Creating a column for clustered classes, to match the other DBs
    Class == "Blade" | Class == "Bladelet" ~ "ElongBlank", # Cluster blades with bladelets. The distinction can come later through a mutate and the measurements
    Class == "Core front" | Class == "Core tablet" | Class == "Core trimming elem." | Class == "Crested piece" ~ "CorePrepProd", # Cluster all preparation products
    Class == "Fragment" ~ "Shatter",
    Class == "Flake distal frag." | Class == "Flake mesial frag." | Class == "Flake prox. frag." ~ "FlakeFrag", # Cluster flake frags into a single category
    Class == "Blade distal frag." | Class == "Blade mesial frag." | Class == "Blade prox. frag." 
    | Class == "Bladelet distal frag." | Class == "Bladelet mesial frag." | Class == "Bladelet prox. frag." ~ "ElongBlankFrag", # Cluster elong frags into a single category
    TRUE ~ Class)) %>% 
  mutate(COREPREPPROD = case_when( # Creating a column for the types of core preparation and maintenance products (COREPREPPROD)
    Class == "Core front" ~ "Core front",
    Class == "Core tablet" ~ "Core tablet",
    Class == "Core trimming elem." ~ "Core trim",
    Class == "Crested piece" ~ "Crested piece")) %>% 
  mutate(PIECECOMPLETENESS = case_when( # Creating a column for the portions present in flake or elongblank fragments to match other DBs
    Class == "Flake distal frag." | Class == "Blade distal frag." | Class == "Bladelet distal frag." ~ "Distal",
    Class == "Flake mesial frag." | Class == "Blade mesial frag." | Class == "Bladelet mesial frag." ~ "Mesial",
    Class == "Flake prox. frag." | Class == "Blade prox. frag." | Class == "Bladelet prox. frag." ~ "Proximal")) %>% 
  rename(PLATFORMTYPE = Platform_type) %>% # Renaming column
  mutate(PLATFORMTYPE = case_when( # Renaming variables to match correspondent variables in the other DBs
    PLATFORMTYPE == "Multifacetted" ~ "Faceted",
    PLATFORMTYPE == "Unfacetted" ~ "Plain",
    TRUE ~ PLATFORMTYPE)) %>%
  mutate(Type = case_when( # Translating retouched types from Zilhão 1997 to simplified typologies
    Type == "92b" ~ "Retouched piece fragment",
    Type == "92a" ~ "Retouched blank",
    Type == "76" ~ "Splintered piece",
    Type == "75" ~ "Denticulate",
    Type == "74" ~ "Notch",
    Type == "66" ~ "Retouched blade",
    Type == "61" ~ "Truncation",
    Type == "28" ~ "Burin",
    Type == "7" | Type == "5b" | Type == "4"  ~ "Endscrapper",
    TRUE ~ Type)) %>%
  rename(LEVEL = Layer, UNIT = Unit, CORTEX = Percent_of_cortex, CORTEXLOCATION = Loc_of_cortex, THICKNESS = Thickness,
         MAXWIDTH = Width, LENGTH = Length, COREPLATFORM = Core_platfform, SCARCOUNT = N_of_Scars, COREABANDON = Core_abandon,
         RETOUCHEDPIECETYPOLOGY = Type)  # Renaming column
  
solutrean_tech <- solutrean_WIP %>%
  dplyr::select(ID, CLASS, LEVEL, UNIT, COREPREPPROD, PIECECOMPLETENESS, CORTEX, CORTEXLOCATION, PLATFORMTYPE,
                SCARCOUNT, THICKNESS, MAXWIDTH, LENGTH, COREPLATFORM, COREABANDON, RETOUCHEDPIECETYPOLOGY)

solutrean_points <- solutrean_points %>% # Creating ID from 
  mutate_at("YEAR", str_replace, "20", "") %>% # Removing initial part of the year to match IDs
  tidyr::unite(col='ID', all_of(cols_to_concat_shelter), sep="-", remove=TRUE)
  
solutrean_tech <- bind_rows(solutrean_tech, solutrean_points) # Uniting technology dataset with points (2167 to 2228)

solutrean_tech <- solutrean_tech %>% # Originally 2228
  distinct(ID, .keep_all = TRUE) # Keeping individual IDs to avoid buckets (down to 1993)

shelter_RM_WIP <- shelter_RM %>%
  mutate_at("ID", str_replace, "VB", "") %>% # Remove "VB" from ID
  mutate(RMTYPE = case_when(
    RMTYPE == "Type 2" ~ "T2",
    RMTYPE == "Chalcedony" ~ "T1", # Altering first group names to final group names. Subtypes are maintained as before.
    RMTYPE == "TYPE 15" ~ "T3",
    RMTYPE == "TYPE 7" ~ "T4",
    RMTYPE == "TYPE 12" ~ "T5",
    RMTYPE == "TYPE 11" ~ "T6",
    RMTYPE == "TYPE 13" ~ "T7",
    RMTYPE == "TYPE 11F" ~ "T8",
    RMTYPE == "TYPE 13B" ~ "T9",
    RMTYPE == "Oolitic" ~ "T10",
    RMTYPE == "TYPE GB" ~ "T11",
    RMTYPE == "ND_A" ~ "INDET",
    .default = RMTYPE)) %>%
  select(AREA, ID, RMTYPE, SUBTYPE, WEIGHT, CORTEXTHICKNESS, CORTEXAPPEARANCE) %>%  # Select variables
  distinct(ID, .keep_all = TRUE) # Keeping individual IDs to avoid buckets

solutrean_dataset <- full_join(solutrean_tech, shelter_RM_WIP, by = "ID") # The complete dataset has 2818 (44 points) entries
solutrean_dataset <- solutrean_dataset %>%
  drop_na(RMTYPE) %>%   # Dropping NAs on the RM database drops dataset to 1514
  drop_na(CLASS) # Dropping NAs on the technological class drops dataset to 914

```

# Assemblage description

```{r}
#| label: general-tables

# Tables with class by raw material type (n and %)
## For Gravettian
gravettian_general <- phase_dataset |>
  filter(Level %in% c(6, 7)) |>
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10", "TL", "INDET"))) |>
  tabyl(CLASS, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front") |> 
  mutate(across(where(is.character), ~ gsub("^0   \\(0\\.00%\\)$", " ", .)))

## For Proto-Solutrean (4E and top of 5)
proto_general <- phase_dataset |> 
  filter(Level %in% c("4E", "4E/5")) |> 
  filter(CLASS != "Chip") |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10", "TL", "INDET"))) |> 
  tabyl(CLASS, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front") |> 
  mutate(across(where(is.character), ~ gsub("^0   \\(0\\.00%\\)$", " ", .)))

## For Solutrean
solutrean_general <- solutrean_dataset |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10", "TYPE 11", "TL", "INDET"))) |> 
  tabyl(CLASS, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front") |> 
  mutate(across(where(is.character), ~ gsub("^0   \\(0\\.00%\\)$", " ", .)))

```

```{r}
#| label: tool-diversity

# Solutrean table
## Table preparation
solutrean_retouch <- solutrean_dataset |>
    mutate(CLASS = case_when(
    CLASS == "Retouched piece" ~ "RetouchedPiece",
    CLASS == "Retouched piece fragment" ~ "RetouchedPieceFrag",
    TRUE ~ CLASS)) |>
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) |>
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY) |>
  filter(RETOUCHEDPIECETYPOLOGY != "") |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    RMTYPE == "TYPE 11" ~ "T11",
    TRUE ~ RMTYPE))
## Janitor tabyl for final table with n and %
solutrean_retouch_tab <- solutrean_retouch |>
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) |>
  adorn_totals(c("row", "col")) |>
  mutate(across(where(is.numeric), ~ ifelse(. == 0, " ", .))) |>
  select(RETOUCHEDPIECETYPOLOGY, T1, T2, T5, T6, T7, T8, T11, INDET, Total) |> # Ordering values
  rename(Typology = RETOUCHEDPIECETYPOLOGY)

# Proto-solutrean table
## Table preparation
proto_retouch <- phase_dataset |>
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) |>
  filter(Level %in% c("4E", "4E/5")) |>
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY) |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    RMTYPE == "TYPE 11" ~ "T11",
    TRUE ~ RMTYPE))
## Janitor tabyl for final table with n and %
proto_retouch_tab <- proto_retouch |>
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) |>
  adorn_totals(c("row", "col")) |> 
  mutate(across(where(is.numeric), ~ ifelse(. == 0, " ", .))) |>
  select(RETOUCHEDPIECETYPOLOGY, T1, T2, T3, T4, T5, T6, T7, T8, T9, TL, INDET, Total) |> # Ordering values
  rename(Typology = RETOUCHEDPIECETYPOLOGY)

# Gravettian table
## Table preparation
gravettian_retouch <- phase_dataset |> 
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) |>
  filter(Level %in% c(6, 7)) |> 
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY) |> 
  dplyr::group_by(RMTYPE) |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    TRUE ~ RMTYPE))
## Janitor tabyl for final table with n and %
gravettian_retouched_tab <- gravettian_retouch |> 
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) |>
  adorn_totals(c("row", "col")) |>
  mutate(across(where(is.numeric), ~ ifelse(. == 0, " ", .))) |>
  select(RETOUCHEDPIECETYPOLOGY, T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, TL, INDET, Total) |> # Ordering values
  rename(Typology = RETOUCHEDPIECETYPOLOGY)

```

## Gravettian (levels 6-7)

The sample studied for the Gravettian occupation (\>2012 excavations) of the Terrace area included 766 artifacts. Of these, 209 (`r round(209*100/766, 2)`%) have an indeterminate chert type (@tbl-general-gravettian). Chalcedony (T1) and local cherts (T2-5) show a total of `r 35+110+17+13+72` artefacts (`r round((35+110+17+13+72)*100/766, 2)`%). Non-local cherts show different numbers of artefacts depending on the type, with T6 and T7 showing the highest values (169 or `r round(169*100/766, 2)`% of the total assemblage, and 86 or `r round(86*100/766, 2)`%, respectively); the other non-local cherts have artefact counts lower than 20 per type. The TL cherts also show smaller numbers, with 12 artefacts, corresponding to 7 different types of TL cherts (table s++ in SOM ++).

@tbl-general-gravettian shows the number and percentages of technological classes per chert type. Local cherts show similar patterns between them, with T2 and T5 being the types with higher numbers of artefacts (n=110 and n=72, respectively). For all local cherts, blanks (including blank fragments) represent more than 50% of the artefacts. Cores and core maintenance products are only present in T2 and T5, although in small frequencies: for T2, cores represent 13.6% (n=15 including core fragments) of the group and core preparation and maintenance products represent 1.8% (n=2). For T5 only 4 core fragments and 1 core preparation and maintenance product are present, all frequencies between \~5-1%. Retouched tools seem to be especially relevant in T2 (n= 20, \~18% including retouched piece fragments), making them the most frequent class after blanks. T5 shows similar percentages of retouched tools and shatter (\~12% and \~14%, respectively). T1 (chalcedony) shows similar patterns to other local cherts, although with higher percentages of shatter (34.3%).

When compared to local cherts, non-local chert types (especially T6 and T7) show similar percentages of blanks (n=`r 44+24` or 40% and `r 21+21`\`or \~50%, respectively) but higher percentages of retouched tools (\~30%). Cores, core fragments and core preparation and maintenance products are also present in all non-local cherts (excluding TL) even if in percentages below 4% (n\<4), as well as shatter (\~12%). The exception is T6 that shows the highest numbers of cores and core fragments (n=8), although with low frequencies (4.6%). The TL cherts show mostly blanks and blank fragments (n=3 and n=2, respectively), and retouched tools (n=4).

```{r}
#| label: tbl-general-gravettian
#| tbl-cap: Number and percentage of technotypological classes by raw material type from the Gravettian assemblage (levels 6 and 7) of the Terrace area of Vale Boi.

kable(gravettian_general)

```

As seen in table @tbl-retouch-gravettian, 170 retouched tools were identified, with 39 (`r round(39*100/170, 2)`%) having an unidentified chert type. From the identified chert types, `r 3+20+4+2+9` (`r round((3+20+4+2+9)*100/170, 2)`%) of retouched tools are from local types, `r 58+24+3+1+3` (`r round((58+24+3+1+3)*100/170, 2)`%) from non-local cherts and 4 are from the TL group. From all chert types, T6 shows the highest numbers of retouched pieces (n=58, `r round(58*100/170, 2)`%). Regarding typologies, 15 types of retouched tools were identified (excluding retouched tool fragments). All these typologies were found in the non-local chert group, while only 7 retouched tool typologies were identified in local cherts/chalcedony. The most common typologies identified in the assemblage (and for all chert types) were burins (n=52), endscrappers (n=17), retouched flakes (n=30) and splintered pieces (n=26). From all these, the majority were produced in non-local chert, mainly T6 and in lesser numbers T7. Although in lesser numbers as well, backed bladelets were also identified (n=6), but only present in non-local chert types (T6 and T7). The presence of burin spalls in local chert, especially T2 (n=9) and non-local cherts (T6 with n=12 and T7 with n=4) is expected due to the prevalence of burins (@tbl-general-gravettian).

```{r}
#| label: tbl-retouch-gravettian
#| tbl-cap: Number and percentage of retouched tools by raw material of the Gravettian assemblage (levels 6 and 7) of the Terrace area.

kable(gravettian_retouched_tab)
  
```

## Proto-Solutrean (levels 4E and top of level 5)

The final lithic sample from the Proto-Solutrean assemblage, consisting of the levels 4E and top of level 5, consists of 635 artifacts. Of these, 167 (`r round(167*100/635, 2)`%) have an indeterminate chert type. Local cherts correspond to `r 32+62+32+158+51` artefacts (`r round((32+62+32+158+51)*100/635, 2)`%), with T4 being the most present local chert (n=158 or `r round(158*100/(32+62+32+158+51), 2)`% of the local types). Non-local types are present in smaller numbers (n=`r 60+47+13+9+1` or `r round((60+47+13+9+1)*100/635, 2)`%), with T6 and T7 being the most relevant (n=60 and n=47, respectively), and the TL group includes 3 artefacts, corresponding to 2 types of TL cherts (Table s++ in SOM ++).

When crossing the lithic class with chert type (@tbl-general-proto), we see that the local types show high frequency of blanks (\>50%, including blank fragments), followed by shatter (\~11-27%). Cores are present in small numbers (n=`r 4+5+13+6`), corresponding to ~9-12% of the classes in each local type, with the exception of T1 (chalcedony), with no cores. Core preparation and maintenance products are absent in all local cherts. For non-local types, especially those with higher number of artefacts (T6-T8), blanks and blank fragments are the most frequent class (48.3%, 53.1% and 69.2%, respectively). Retouched tools are present in smaller frequencies for the previous mentioned chert types (\~17-23%). For T6 the absence of cores but the presence of shatter and a single core preparation and maintenance product suggests knapping on site; all other non-local types show at least 1 core and frequently the presence of shatter. As expected, the TL artifacts include a blank and a retouched. However, a shatter was also identified.

```{r}
#| label: tbl-general-proto
#| tbl-cap: Number and percentage of technotypological classes by raw material type from the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area of Vale Boi.

kable(proto_general)

```

In total, 65 chert retouched tools were identified, with 23.1% (n=15) having an unidentified chert type (@tbl-retouch-proto). A total of `r 1+10+2+8+5` (`r round((1+10+2+8+5)*100/65, 2)`%) retouched tools correspond to local cherts, while `r 10+9+3+1+1` (`r round((10+9+3+1+1)*100/65, 2)`%) correspond to non-local and TL cherts. As seen in @tbl-retouch-proto, 14 different types of retouched tools were identified. Endscrappers (26.2%), splintered pieces (17%), burins (12.3%) and retouched flakes (7.7%) were the most prevalent. Local raw materials show 9 different typologies, with Vale Comprido points, Solutrean retouch and notches being present only in the local types, even if in small numbers. Non-local cherts show 10 different typologies of retouched tools. Perforator-endscrapper, truncation, backed bladelet and retouched blades typologies can only be found in non-local varieties, albeit also in small numbers.

```{r}
#| label: tbl-retouch-proto
#| tbl-cap: Number and percentage of retouched tools by raw material of the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area.

kable(proto_retouch_tab)

```

## Solutrean (levels A to C)

The Solutrean assemblages show similar patterns to those observed in previous assemblages. The final sample from levels A, B and C from the Solutrean occupations of the Shelter area consists of 914 artifacts. Of these, 201 (`r round(201*100/914, 2)`%) correspond to the indeterminate chert group. Local cherts correspond to `r 16+506+4+10+30` (`r round((16+506+4+10+30)*100/914, 2)`%) artefacts, mostly from T2 (n=506). Non-local cherts (including the TL group) correspond to `r 86+9+30+3+1+17+1` (`r round((86+9+30+3+1+17+1)*100/914, 2)`%) artefacts, mostly from T6 (n=86).

When crossing the class data with type of raw material (@tbl-general-solutrean), we see that for local chert, especially T2, the majority of the debitage is composed of flakes and elongated blanks (83.9%). Cores are also present (10.5%), alongside a small percentage of core preparation and maintenance products (1.3%). In comparison to debitage products, retouched tools are scarce in the sample (\~3%). Non-local cherts, especially T6 and T8, show similar patterns to the local cherts, with high percentages of blanks (\>50%). Cores and core preparation and maintenance are also present in small percentages (\~3-6% and 3.5% only for T6, respectively), as well as retouched tools (\<10%). However, these specific results are truncated by the lack of shatter, which were not present in the sample used for the study (see Materials and Methods section).

```{r}
#| label: tbl-general-solutrean
#| tbl-cap: Number and percentage of technotypological classes by raw material type from the Solutrean assemblage (levels A to C) of the Shelter area of Vale Boi.

kable(solutrean_general)

```

The analysed Solutrean sample has a total of 43 retouched tools (complete and fragments), with `r 3+13+1` corresponding to local cherts and `r 7+1+2+3` to non-local cherts, with the remaining being cherts of unidentified type. These results are significantly reduced from the original dataset (Cascalheira et al., 2013), possibly due to no bucket coordinates being used.
From the 43 retouched tools, 11 different typologies were identified (without accounting for fragments). 
The typologies which are most frequently present in the studied sample are bifacial blanks and bifacial fragments (n=10). Two types of points were identified: shouldered points (n=3, including fragments) and tanged and winged points (n=4). Other frequent retouched typologies are retouched blanks (n=6), notches (n=5), splintered pieces (n=5) and endscrappers (n=4). Local types show a higher variability retouched typologies (9 types), although this may be related to the higher number of tools. In comparison, Type 6 shows only 5 different typologies.

```{r}
#| label: tbl-retouch-solutrean
#| tbl-cap: Number and percentage of retouched tools by raw material of the Solutrean assemblage (level A to C) of the Shelter area.

kable(solutrean_retouch_tab)

```

# Blank-to-core ratios

```{r}
#| label: ratio-blankcore

# Solutrean ratio
solutrean_ratiobc <- solutrean_dataset %>% 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" | CLASS == "Thinning flake" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    TRUE ~ CLASS)) %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(RMTYPE != "INDET") %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Blank/Core" = Blank / Core)

# Proto-Solutrean ratio
proto_ratiobc <- phase_dataset %>% 
  filter(Level %in% c("4E", "4E/5")) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>%
  mutate("Blank/Core" = Blank / Core)

# Gravettian ratio
gravettian_ratiobc <- phase_dataset %>% 
  filter(Level %in% c(6, 7)) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Blank/Core" = Blank / Core)


```

```{r}
#| label: tbl-bcratio
#| tbl-cap: Blank to core ratio by raw material of the Solutrean (a), Proto-Solutrean (b) and Gravettian (c) assemblages.
#| tbl-subcap: 
#|  - "Blank to core ratio by raw material of the Solutrean assemblage (levels A to C) of the Shelter area."
#|  - "Blank to core ratio by raw material of the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area."
#|  - "Blank to core ratio by raw material of the Gravettian assemblage (levels 6 and 7) of the Terrace area."
#| layout-nrow: 4

kable(head(solutrean_ratiobc))
kable(head(proto_ratiobc))
kable(head(gravettian_ratiobc))

```

# Tool-to-debitage ratios

```{r}
#| label: ratios-retouchdebitage

# Solutrean
solutrean_ratiotd <- solutrean_dataset %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" | CLASS == "Thinning flake" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    CLASS == "Retouched piece" ~ "RetouchedPiece",
    CLASS == "Retouched piece fragment" ~ "RetouchedPieceFrag",
    TRUE ~ CLASS)) %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

# Proto-Solutrean
proto_ratiotd <- phase_dataset %>% 
  filter(Level %in% c("4E", "4E/5")) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

proto5_ratiotd <- phase_dataset %>% 
  filter(Level == 5) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

# Gravettian
gravettian_ratiotd <- phase_dataset %>% 
  filter(Level %in% c(6, 7)) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

```

```{r}
#| label: tbl-tdratio-solutrean
#| tbl-cap: Tools to debitage ratio by raw material of the Solutrean (a), Proto-Solutrean (b) and Gravettian (c) assemblages.
#| tbl-subcap: 
#|  - "Tools to debitage ratio by raw material of the Solutrean assemblage (levels A to C) of the Shelter area."
#|  - "Tools to debitage ratio by raw material of the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area."
#|  - "Tools to debitage ratio by raw material of the Gravettian assemblage (levels 6 and 7) of the Terrace area."
#| layout-nrow: 4

kable(head(solutrean_ratiotd))
kable(head(proto_ratiotd))
kable(head(gravettian_ratiotd))

```

# Measurements

```{r}
#| label: stats-setup

# Solutrean statistics
# DS preparation
solutrean_stats <- solutrean_dataset %>% 
  filter(RMTYPE != "INDET") %>%
   mutate(CLASS = case_when(
    CLASS == "Thinning flake" ~ "ThinningFlake",
    CLASS == "ElongBlank" ~ "ElongatedProd",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    CLASS == "Retouched piece" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "BlankFragProx", # To add proximal fragments to ratio
    TRUE ~ CLASS))

# Tables with individual class. For supplementary information if necessary
# For flakes (complete)
solutrean_stats_flakes <- solutrean_stats %>% 
  filter(CLASS == "Flake") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For elongated blanks (complete)
solutrean_stats_elong <- solutrean_stats %>% 
  filter(CLASS == "ElongatedProd") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For cores
solutrean_stats_cores <- solutrean_stats %>% 
  filter(CLASS == "Core") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For retouched
solutrean_stats_retouch<- solutrean_stats %>% 
  filter(CLASS == "RetouchedPiece") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))

# Proto-Solutrean statistics
# DS prep
proto_stats <- phase_dataset %>% 
  filter(Level %in% c("4E", "4E/5")) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "BlankFragProx", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>%
  mutate(elong = MAXWIDTH*2-LENGTH) %>%
  mutate(CLASS = case_when(
    CLASS == "Blank" & elong > 0 ~ "Flake", # QUESTION: do I keep flakes and elong separate or join into blanks?
    CLASS == "Blank" & elong <= 0 ~ "ElongatedProd",
    TRUE ~ CLASS))

# Tables with individual class. For supplementary information if necessary
# For flakes (complete)
proto_stats_flakes <- proto_stats %>% 
  filter(CLASS == "Flake") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For elongated blanks (complete)
proto_stats_elong <- proto_stats %>% 
  filter(CLASS == "ElongatedProd") %>% 
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For cores
proto_stats_cores <- proto_stats %>% 
  filter(CLASS == "Core") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For retouched
proto_stats_retouch <- proto_stats %>% 
  filter(CLASS == "RetouchedPiece") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))

# Gravettian statistics
# DS prep
gravettian_stats <- phase_dataset %>%
  filter(Level %in% c(6, 7)) %>%
  filter(RMTYPE != "INDET") %>%
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "BlankFragProx", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  mutate(elong = MAXWIDTH*2-LENGTH) %>%
  mutate(CLASS = case_when(
    CLASS == "Blank" & elong > 0 ~ "Flake", # QUESTION: do I keep flakes and elong separate or join into blanks?
    CLASS == "Blank" & elong <= 0 ~ "ElongatedProd",
    TRUE ~ CLASS))

# Tables with individual class. For supplementary information if necessary
# For flakes (complete)
gravettian_stats_flakes <- gravettian_stats %>% 
  filter(CLASS == "Flake") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For elongated blanks (complete)
gravettian_stats_elong <- gravettian_stats %>% 
  filter(CLASS == "ElongatedProd") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For cores
gravettian_stats_cores <- gravettian_stats %>% 
  filter(CLASS == "Core") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))
# For retouched
gravettian_stats_retouch <- gravettian_stats %>% 
  filter(CLASS == "RetouchedPiece") %>%
  select(RMTYPE, CLASS, THICKNESS, MAXWIDTH, LENGTH, WEIGHT) %>% 
  group_by(RMTYPE, CLASS) %>% 
  summarise(across(c(THICKNESS, MAXWIDTH, LENGTH, WEIGHT), list(mean = mean, sd = sd, max = max, min = min)))

```

```{r}
#| label: tbl-solutrean
#| tbl-cap: "Stats for Solutrean occupation."
#| tbl-subcap: 
#|  - "Stats for flakes"
#|  - "Stats for elongated blanks"
#|  - "Stats for cores"
#|  - "Stats for retouched"
#| layout-nrow: 4

kable(head(solutrean_stats_flakes))
kable(head(solutrean_stats_elong))
kable(head(solutrean_stats_cores))
kable(head(solutrean_stats_retouch))

```

```{r}
#| label: tbl-proto
#| tbl-cap: "Stats for Proto-Solutrean occupation."
#| tbl-subcap: 
#|  - "Stats for flakes"
#|  - "Stats for elongated blanks"
#|  - "Stats for cores"
#|  - "Stats for retouched"
#| layout-nrow: 4

kable(head(proto_stats_flakes))
kable(head(proto_stats_elong))
kable(head(proto_stats_cores))
kable(head(proto_stats_retouch))

```

```{r}
#| label: tbl-gravettian
#| tbl-cap: "Stats for Gravettian occupation."
#| tbl-subcap: 
#|  - "Stats for flakes"
#|  - "Stats for elongated blanks"
#|  - "Stats for cores"
#|  - "Stats for retouched"
#| layout-nrow: 4

kable(head(gravettian_stats_flakes))
kable(head(gravettian_stats_elong))
kable(head(gravettian_stats_cores))
kable(head(gravettian_stats_retouch))

```

# TL cherts

```{r}
#| label: tbl-TL-classes
#| tbl-cap: Trace lithologies cherts from the Gravettian and Proto-Solutrean assemblages of the Terrace and Solutrean assemblage from the Shelter and corresponding technological class.

TL_classes_terrace <- phase_dataset |> 
  filter(RMTYPE == "TL") |> 
  filter(Level != "5") |>
  select(Technocomplex, SUBTYPE, ID, CLASS, RETOUCHEDPIECETYPOLOGY)

TL_classes_shelter <- solutrean_dataset |> 
  mutate(Technocomplex = case_when(
    LEVEL == "A" | LEVEL == "B" | LEVEL == "C" ~ "Solutrean")) |> 
  filter(RMTYPE == "TL") |> 
  select(Technocomplex, SUBTYPE, ID, CLASS, RETOUCHEDPIECETYPOLOGY)

TL_classes <- rbind(TL_classes_terrace, TL_classes_shelter)
TL_classes <- TL_classes |> 
  rename(TL = SUBTYPE) |> 
  arrange(TL)

kable(head(TL_classes))

```
