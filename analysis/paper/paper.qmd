---
title: "Placeholder for article 3"
author:
  - Jane Doe:
      correspondence: "yes"
      email: janedoe@fosg.org
      orcid: 0000-0003-1689-0557
      institute:
        - fosg
        - fop
  - John Q. Doe:
      institute: fosg
      orcid: 0000-0003-1689-0558
  - Peder Ås:
      institute: fosg
      orcid: 0000-0003-1689-0559
  - Juan Pérez:
      orcid: 0000-0003-1689-0551
      institute:
        - name: Acme Corporation
  - Max Mustermann:
      orcid: 0000-0003-1689-0552
institute:
  - fosg:
      name: Formatting Open Science Group
      address: 23 Science Street, Eureka, Mississippi, USA
  - fop: Federation of Planets
title-block-published: "Last updated"  
date: now
date-format: long
format: 
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
execute:
  echo: false
  warning: false
  message: false
  comment: "#>"
  fig-path: "../figures/"
  fig-dpi: 600
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The actual document text starts here: -->

# Introduction

Lithic technological organisation has long been a central focus in archaeology for the insights it offers into past human behaviour and lifeways. Nelson (1991) defines lithic technological organisation as the selection and integration of strategies for the production, use, transportation, discarding, and management of tools and raw materials. Kelly (1988) describes it as the interplay of space and time in lithic tool production within a cultural system. This includes activities such as raw material sourcing and distribution, tool manufacture, use, reuse, and discard, as well as broader behavioural patterns like mobility and settlement systems. Together, these definitions underscore the multifaceted nature of lithic technological organisation and its utility in examining key aspects of hunter-gatherer adaptations over time.
	
Raw material procurement is a key aspect of lithic technological organisation, as it played a crucial role in the lives of past hunter-gatherer groups by determing the possibilities for tool production and use (Bamforth & Bleed, 1997). Approaches focused on the study of raw materials provide key knowledge on several topics of hunter-gatherer organisation such as procurement and mobility strategies (Ambrose, 1990; Binford, 1979, 1985; Gould, 1985; Kuhn, 1991; Mccall, 2007), occupation types and their duration (Kuhn, 2004; Surovell, 2009; Grove, 2023), and social networks and exchanges (Whallon, 2006; Gamble, 1999). These approaches focus on the characterisation of geological and archaeological raw materials to identify local and non-local raw materials within an assemblage, their possible sources, and examine their proportions within a site over different occupations and periods.
	
Similar studies have also been applied to lithic assemblages from prehistoric archaeological sites in the Iberian Peninsula (e.g., Aubry et al. 2016; Aubry and Igreja 2009; García-Rojas et al. 2021; Gómez de Soler et al. 2020; Herrero-Alonso et al. 2020; Matias 2016; Nocete et al. 2005; Ortega 2003; Pereira, Andrade, et al. 2016; Pereira et al. 2021, 2022; Ramacciotti et al. 2022; Rodríguez et al. 2011; Sánchez de la Torre et al. 2023; Soto 2016), and contributed to understanding how different groups explored the available lithic resources, aided in identifying extensive movements and social networks throughout the Upper Palaeolithic (e.g., Aubry et al. 2004, 2016;  Corchón Rodríguez et al. 2016; Hermida et al. 2016; Marreiros et al. 2016; Sánchez de la Torre et al. 2023).

Until recently, the study of raw materials in southwestern Iberia was limited, and knowledge about mobility and social networks was limited to technological studies, derived from the archaeological site of Vale Boi. This site is crucial for understanding Upper Paleolithic (UP) adaptations, as it is currently the only site in southwestern Iberia with a long-term occupation spanning most of the UP, enabling the exploration of cultural and technological trends over time (Cascalheira et al. 2017). For example, Vale Boi has provided valuable insights into hunter-gatherer subsistence strategies, technological organisation (Belmiro et al. 2021; Nuno Bicho et al. 2013; Cascalheira et al. 2017; Cascalheira 2019; Horta et al. 2019; Manne et al. 2012; Marreiros et al. 2016). This also contributed to understanding different patterns of territory exploitation and contact with other regions of Iberia throughout the UP.

During the Solutrean period, Vale Boi served as a key connection point between central Portugal and southern Spain, facilitating social networks and cultural exchanges (Cascalheira, 2013; Cascalheira et al., 2017). Proto-Solutrean evidence also indicates technological similarities and close contact with central Portugal (Belmiro et al., 2021). In contrast, studies of Gravettian occupations reveal marked regional differences, suggesting more limited movement of people and information in southwestern Iberia (Marreiros and Bicho, 2013).

Recent research has expanded our understanding of mobility and social networks through lithic raw material studies. Our team’s recent work (Belmiro et al., 2025) identified non-local cherts originating from central Portugal (>250 km from Vale Boi) and souuthern Spain (>200 km from Vale Boi). The proportions of these materials varied across the UP, with earlier occupations (Gravettian) showing high frequencies of non-local chert, while later ones (Proto-Solutrean and Solutrean) exhibited a marked decline. These findings suggest the establishment and maintenance of extensive social networks connecting southwestern Portugal to Southern spain and central Portugal as early as the beginning of the UP.

These results, particularly those related to the Gravettian, were interpreted as outcomes of residential mobility rather than direct social network influences, though further investigation is required. While distance to source and raw material proportions offer valuable insights, they represent only one aspect of raw material procurement and management. A raw material-focused approach alone is insufficient for comprehensively understanding mobility patterns and technological organisation. Indeed, numerous studies and models from both ethnographic and archaeological perspectives have demonstrated the complex interplay between lithic technological variability, raw material provisioning, and mobility.

For example, technological variability within a lithic assemblage may be explained by the abundance and quality of raw materials (Andrefsky, 1994; Brown, 1999; Oestmo, 2017). Whenever raw materials in proximity to a residential site are abundant and of good quality, a high percentage of formal tools are produced (Andrefsky, 1994; Perlès, 1992), and artefacts show less reduction intensity and decreased conversation through retouch (Thacker, 2002). Whenever local raw materials are scarce or of low quality, non-local resources are procured to produce mostly formal tools (Andrefsky, 1994; Perlès, 1992). Similarly, when groups move to areas where raw material is scarcer or of poorer quality, more effort is placed into the preparation of transportable cores and the production of tools (Kelly, 1988).

However, the different patterns between local and non-local raw material proportion and use in lithic assemblages may be less obvious whenever prehistoric groups have easy access to non-local raw materials due to high mobility or exchanges between groups (Akerman et al., 2002; Torrence, 1996; Brown, 1999; Oestmo). Furthermore, Roth and Dibble (1998) demonstrate that even in areas where good quality raw material is abundant, non-local raw materials were still transported to the site, often in the form of large blanks or trimmed cores, and both local and non-local raw materials were retouched into tools.

Tools, flakes and cores often functioned as portable sources of raw material within mobile toolkits or during non-local raw material procurement, enabling stone knapping during periods of limited time or in environments with scarce or unsuitable materials (Kelly, 1988; Morrow, 1996; Gould et al., 1971; Kuhn, 1994; Perlès, 1992; Shott, 1986). For example, the transport of formal cores (e.g., blade cores) and bifaces used as cores have been interpreted as lightweight and reconfigurable raw material storage strategies (Clark, 1987; Kelly, 1988).

Formal tools and the degree of tool maintenance have also been associated with planned preparation, efficient use, and transportability, reflecting their connection to mobile settlement strategies, short-term site occupations (Torrence, 1983) and the regional distribution of raw materials (Bamforth, 1986). For example, non-local raw materials, transported as part of personal toolkits (frequently associated with residential mobility), would primarily arrive at sites as retouched pieces (Kuhn, 2004). These artefacts would show higher degrees of reduction and reworking (Kuhn, 2004) and a higher percentage of non-cortical flakes (Roth and Dibble 1998), as they would have been in use for an extended period before being discarded. When knapped on-site, non-local materials also tend to exhibit higher proportions of retouched tools compared to local materials.

Tool variability and size are also impacted by mobility and uncertainty regarding raw material availability; increased group mobility may create a pattern of limited tool variability, and tools may become less specialised and easily reconfigurable, such as retouched blanks (Shott, 1986; Odell, 1981; Siegel, 1984). Increased mobility also often results in smaller tools (Shott, 1986), although other authors have noted that large tools may be well-suited to a mobile lifestyle due to their extended use-life, allowing them to remain functional in areas where raw materials are scarce or unsuitable for knapping (Morrow, 1996).

The proportions of local vs non-local raw materials discussed thus far have focused greatly on group mobility, which is linked with residential mobility and occupation duration. Residential mobility (e.g., foraging range size and frequency of residential moves) is a defining characteristic of hunter-gatherer societies and plays a central role in their lifeways (Kelly, 1995). It is a key factor driving changes in lithic assemblages (Brown, 1999; Oestmo, 2017; Roth & Dibble, 1998) as it significantly impacts the cost and use of artefacts and raw materials since they affect the relation between the distance of raw material sources to sites (Kuhn, 2004). As such, different raw material and technological patterns have been observed between short-term and long-term occupations.

Short-term occupations typically rely on transported (non-local) toolkits (Torrence, 1983) and raw materials (Surovell, 2009), show higher reduction intensity, and an increased tools-to-debitage ratio in the assemblages (Grove et al., 2023). Long-term occupations, typically rely on provisioning sites with locally available and suitable raw materials, while non-local materials are gradually used and discarded (Grove et al., 2023; Surovell, 2009). Non-local raw material cores are highly reduced and extensively exploited (Kuhn, 2004; Roth & Dibble, 1998) and exhibit higher blank-to-core ratios (Roth & Dibble, 1998).

These studies highlight significant variability in lithic assemblages and raw material proportions, reflecting different facets of hunter-gatherer technological organisation. This variability appears between behaviourally and ethnically similar sites (Bamforth, 1986), across distinct chrono-cultural periods, and even within a single site among various raw materials. To fully understand past hunter-gatherer behaviours, organisation, and lifeways, it is crucial to examine all stages of lithic production—procurement, distribution, use, maintenance, and discard—through interconnected approaches that combine lithic technology and raw material analyses.

Building on the studies mentioned above and existing (yet currently uncorrelated) data on UP lithic technology and raw material analyses at Vale Boi, we outline the expectations and objectives for the current study.


## Aims

Our goal is to understand the provisioning, use and management strategies of chert lithic resources of the hunter-gatherer groups of Vale Boi during the Upper Paleolithic. We focus on the technological characteristics of the two broader groups of cherts identified at the site: local and non-local, based on the notion that local raw materials will show technological patterns different from those which are non-local. Expanding upon our previous works on chert types present throughout the UP sequence in the Terrace and Shelter area of Vale Boi, and their possible interpretations, and following the previously mentioned studies and models about raw material management and lithic technology organisation focusing mainly on the different management of local and non-local raw materials, associated with mobility and occupation length, we derive two main expectations (fig. 1):

1.  Local raw materials are expected to present a) low use-lives, with knapping strategies characterised by manufacture, use and discard; b) a decreased reduction intensity and low tools to debitage ratio; c) larger cores and lower blank-to-core ratio; d) less extensive reduction and reworking of tools; e) higher tool typology diversity. This may be related to the abundance of local raw materials which leads to less intensive life-use extension, but also to the residential characteristics of the site and low mobility, which increases the reliance on local raw materials.

2.  Non-local raw materials are expected to present a) a majority of formal tools, in the case of individual provisioning or higher use-lives, with knapping strategies characterised by the manufacture, use and maintenance; b) an increased reduction intensity and high tools to debitage ratio; c) smaller cores and higher blank-to-core ratio; d) more extensive reduction and high presence of retouch and/or tool maintenance; e) lower tool diversity, characterised by less specialised tools, such as the presence of retouched blanks as multipurpose tools. This may be related to scarcer or poorer quality of raw materials which leads to the prepared transportation of lithic resources to a site, but also related to more mobile settlement patterns as well as short-term site occupations.

Despite these expectations, it is important to notice that, especially in occupations with a high percentage of non-local cherts at the site (e.g., Gravettian occupations of level 7 and 6 of the Terrace at Vale Boi), these technological may not reflect a preoccupation with intensive management of a scarce and limited non-local resource, and be more a reflection of the type of provisioning applied following the suggested model by Kuhn (2004). In this sense, distance from source may have had little intrinsic meaning in the past, especially regarding non-local raw materials. There are several ways in which raw materials may be transported to a site, and the relationship between distance and cost may vary depending on how this takes place [@kuhn2004]. When non-local raw materials are as abundant as local ones, the difference in the technological organization between these materials may be less obvious (Andrefsky, 2004).

## Site descriptions

Vale Boi is situated on the western coast of the Algarve region in southern Portugal, within a small valley that stretches southward to the Atlantic coast, approximately 2 km away. The site is bordered by limestone outcrops, which form rock shelters facing west and southwest. Covering more than 10,000 square meters along the valley slope, Vale Boi includes three main excavated areas: Slope, Terrace, and Shelter, which were excavated between 2000 and 2019 (Bicho et al., 2007, 2012, 2013; Cascalheira et al., 2017; Cascalheira & Bicho, 2013; Manne et al., 2012). Based on the available raw material and technological data, particularly the macroscopic and petrographic research (Belmiro et al., 2025), the Terrace and Shelter areas were selected for the current study.

The Terrace spans occupations from the UP to the Early Neolithic. Although excavations began in 2000, a new 8-square-meter area was opened in 2012 to better understand the stratigraphic sequence and assess the potential presence of older cultural layers, which could be linked to an early Upper Paleolithic occupation. Between 2012 and 2016, eight primary litho-stratigraphic units were identified. The UP sequence includes multiple occupations, spanning ~10,000 years: Gravettian (levels 8 to 6) between approximately c. 32 and 27 ka cal BP, Proto-Solutrean (levels 5 to 4E) between approximately c. 26 and 24 ka cal BP, and Solutrean (levels 4D, 4C, 4, and Lower 3) between approximately c. 24 and 20 ka cal BP (Belmiro et al., 2021; Cascalheira et al., 2017; Cascalheira & Bicho, 2013).

The Shelter area contains four main lithostratigraphic units, with occupations from the Magdalenian, Solutrean, and Gravettian periods. The Magdalenian and Gravettian levels (Z and D, respectively) were partially eroded, while the Solutrean levels represent the most intensive occupation, with three well-preserved archaeological horizons (layers C to A), dated to approximately c. 24-22 ka cal BP. These occupation levels were found beneath blocks of limestone that likely collapsed from the rockshelter ceiling, probably shortly after the Last Glacial Maximum (Cascalheira, 2010; Cascalheira et al., 2017).

Most of these occupations resulted in large lithic assemblages, encompassing all lithic production stages and use of several raw materials, often for specific uses. Research on the lithic assemblages of the site have allowed the technological and cultural characterisation of human groups occupying the site, which show some differences through the different UP occupations. Given the chosen sample for this study (see section 2 “Materials and methods”), we summarise here the results for the technological analysis of the Solutrean assemblages (levels A-C) of the Shelter (Cascalheira, 2010; Cascalheira et al., 2013) and the Proto-Solutrean assemblages (levels 4E-5) of the Terrace (Belmiro, 2020; Belmiro et al., 2021). The Gravettian occupations (Levels 6-8) of the Terrace have been recently studied, but the results remain unpublished.

The lithic analysis of the Shelter Solutrean levels (A-C) shows a high number of lithic artifacts, with over 22 000 artifacts analysed (including chips which correspond to ~60% of the assemblage and shatter ~17-19%). The volumes introduced into the site were mostly cortical, given the high frequencies of cortex in blanks and retouched tools. The knapping strategies are dominated by unidirectional and bidirectional prismatic, with frequent core maintenance products. Flakes dominate the debitage assemblage, and endscrapers, notches, splintered pieces and retouched blades/flakes are the most common retouched tools. Stemmed and winged points, laurel leaves, shouldered points and parpalló points were also identified (Cascalheira et al., 2013).

The Proto-Solutrean horizons yielded more than 26,500 artifacts (including chips which correspond to ~65-70% of the assemblage and shatter ~20%), ~11,000 attributed to the lower bottom of level 5 and ~15,600 attributed to the top of level 5 and level 4E. Both horizons are characterised by knapping strategies dominated by unidirectional prismatic cores, with little platform preparation, focused on the obtention of bladelets (in bottom level 5) and flakes. Retouched tools are dominated by splintered pieces, endscrapers and retouched blanks, with Vale Comprido points (the Proto-Solutrean fossil director) being barely inexistent in chert and mostly produced in dolerite (Belmiro et al., 2021).

Previous studies showed that the main raw materials used at the site are chert, quartz and greywacke, with the percentages of these changing between occupations. For example, while studies show a high degree of quartz in the lower Proto-Solutrean levels (Belmiro et al., 2021), in the Solutrean occupations of the Shelter a dominance of chert was observed (Cascalheira, 2010). Similarly, different raw materials have been observed to play specific roles, such as the case of chert for the production of a high percentage of blanks and retouched tools. While quartz and greywacke can be found locally, in the streams and adjacent to the site, chert sources are further away, although still within a ~20 km radius of the site. Our previous study showed, as expected, the existence of local chert in the assemblages, originating from the Lower Jurassic outcrops in proximity to the site (Belmiro et al., 2025). As previously mentioned, a portion of non-local cherts was also identified, with some identified sources, such as the Cretaceous outcrops of Central Portugal (Lisbon and Rio Maior areas) and the Upper Jurassic oolitic/peloidal cherts of the Betic Systems in southern Spain. This suggests contacts or long-range mobility patterns of the groups occupying Vale Boi all throughout the UP, although in different degrees, possibly related to changes in the settlement patterns and duration of site occupation.

Both these areas have been previously interpreted as seasonal residential camps, repeatedly used for extended stays, due to the abundance of lithic debitage, stone tools, heat-cracked rocks related to grease rendering activities, large quantities of faunal remains (both marine and terrestrial) and the presence of ornaments and portable art [@manneIntensiveSubsistencePractices2012]. This is true for most of the occupations (levels), with exception of the Early Gravettian occupations of the Terrace area and Magdalenian occupation of the Shelter.

Using the Whole Assemblage Behavioral Index (WABI), previously used in other studies (Riel-Salvatore, 2010; Riel-Salvatore & Barton, 2004), Cascalheira et al., (2017) used the lithic results from the Shelter Solutrean levels (Cascalheira, 2010; Cascalheira et al., 2013) and Magdalenian levels (Mendonça, 2009), and the Gravettian levels of Terrace (Marreiros et al., 2015) to reconstruct and compare the mobility strategies of the several occupations, through the lithic volumetric density and the frequency of retouched tools. This method allowed the confirmation that, except from the Early Gravettian and Magdalenian occupations, all other occupations are composed of high-density assemblages with low degree of retouch, correspondent to a residential base-camp occupation, for extended periods of time. Regarding the Terrace area, however, the results were based on previous excavations (<2012), and the identification of new layers and reorganization of the occupations is yet to be tested through the use of lithic techno-typological methods.

A similar conclusion was suggested based on the interpretation of the chert sourcing and proportions in the several UP occupations of the Terrace and Shelter of Vale Boi, and following other models relating local/non-local raw materials with mobility (Grove et al., 2023; Surovell, 2009). The high proportions of non-local chert (~50%) in the Gravettian occupations (levels 6 and 7), and gradual reduction in the following occupations, were interpreted as a possible result of settlement changes, where the Gravettian occupations corresponded to short-term occupations, and the other occupations corresponded to residential, long-term occupations with more infrequent moves (Belmiro et al., 2025).


# Materials and methods



# Results

```{r}
#| label: library

# Read libraries necessary for running the script
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(janitor)
library(ggpubr)
library(knitr)

```

```{r}
#| label: get-data

# Reading the datasets
## Technological data
gravettian_tech <- read.csv(here::here('analysis/data/raw_data/VBT_6_7_JB.csv'))
proto_tech <- read.csv(here::here('analysis/data/raw_data/VBT_4E_5_JB.csv'))
solutrean_JC <- read.csv(here::here('analysis/data/raw_data/VBR_ABC_JC.csv'))
solutrean_points <- read.csv(here::here('analysis/data/raw_data/shelter_points_JC.csv'))

## RM data
shelter_RM <- read_csv(here::here('analysis/data/raw_data/MACRO_IND_SHELTER.csv')) # Shelter RM analysis
terrace_RM <- read_csv(here::here('analysis/data/raw_data/MACRO_IND_TERRACE.csv')) # Terrace RM analysis

## Context data
context <- read_csv(here::here('analysis/data/raw_data/VB_Terrace_context.csv')) # Terrace Field DB - lithic artefact info
xyz <- read_csv(here::here('analysis/data/raw_data/VB_Terrace_xyz.csv')) # Terrace Field DB - just coordinates

```

```{r}
#| label: terrace-databases-setup

# Setting up the Terrace dataset
cols_to_concat_terrace <- c("UNIT", "ID") # Vector to join UNIT and ID into a single variable
context$ID <- str_squish(context$ID) # Remove empty spaces from ID field
xyz$ID <- str_squish(xyz$ID) # Remove empty spaces from UNIT field

# Cleaning up DS and uniformising variable names
proto_tech_WIP <- proto_tech %>%
  tidyr::unite(col='ID', all_of(cols_to_concat_terrace), sep="-", remove=TRUE) %>% 
  rename(CLASS = Class, COREPREPPROD = CorePreparProd, PIECECOMPLETENESS = PieceCompleteness, CORTEX = Cortex, CORTEXLOCATION = CortexLocation, PLATFORMTYPE = PlatformType, PLATFORMCORTEX = PlatformCortex, SCARCOUNT = ScarCount, THICKNESS = Thickness,
        MAXWIDTH = MaxWidth, LENGTH = Length, COREPLATFORM = CorePlatform, MAINFACECORTEX = MainFaceCortex, 
        MAINFACESCARCOUNT = MainFaceScarCount, COREABANDON = CoreAbandon, RETOUCHEDPIECETYPOLOGY = RetouchedPieceTypology) %>% 
  mutate(RETOUCHEDPIECETYPOLOGY = case_when(
    RETOUCHEDPIECETYPOLOGY == "Right truncation on retouched piece" ~ "Truncation",
    RETOUCHEDPIECETYPOLOGY == "Double backed bladelet" | RETOUCHEDPIECETYPOLOGY == "Backed bladelet parcial" ~ "Backed bladelet",
    RETOUCHEDPIECETYPOLOGY == "Dentilhado" ~ "Denticulate",
    RETOUCHEDPIECETYPOLOGY == "Burin on truncation" ~ "Burin",
    TRUE ~ RETOUCHEDPIECETYPOLOGY)) %>% 
  dplyr::select(ID, CLASS, COREPREPPROD, PIECECOMPLETENESS, CORTEX, CORTEXLOCATION, PLATFORMTYPE, PLATFORMCORTEX,
                SCARCOUNT, THICKNESS, MAXWIDTH, LENGTH, COREPLATFORM, MAINFACECORTEX, MAINFACESCARCOUNT, COREABANDON, RETOUCHEDPIECETYPOLOGY)

gravettian_tech <- gravettian_tech %>% 
  mutate(RETOUCHEDPIECETYPOLOGY = case_when(
    RETOUCHEDPIECETYPOLOGY == "Splintered piece with notch" | RETOUCHEDPIECETYPOLOGY == "Splintered piece with lateral retouch" ~ "Splintered piece",
    RETOUCHEDPIECETYPOLOGY == "Retouched flake siret fragment" | RETOUCHEDPIECETYPOLOGY == "Retouched flake frag" ~ "Retouched flake fragment",
    RETOUCHEDPIECETYPOLOGY == "Retouched bladelet frag" ~ "Retouched bladelet fragment",
    RETOUCHEDPIECETYPOLOGY == "Multiple burin" | RETOUCHEDPIECETYPOLOGY == "Burin splintered piece" | RETOUCHEDPIECETYPOLOGY == "Burin on truncation" ~ "Burin",
    RETOUCHEDPIECETYPOLOGY == "Double backed bladelet" ~ "Backed bladelet",
    TRUE ~ RETOUCHEDPIECETYPOLOGY)) %>% 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    TRUE ~ CLASS))

terrace_tech <- bind_rows(proto_tech_WIP, gravettian_tech) # Creating single DS with Proto and Gravettian

terrace_RM_WIP <- terrace_RM %>%
  mutate(RMTYPE = case_when(
    RMTYPE == "Type 2" ~ "TYPE 2",
    RMTYPE == "Chalcedony" ~ "TYPE 1", # Altering first group names to final group names. Subtypes are maintained as before.
    RMTYPE == "TYPE 15" ~ "TYPE 3",
    RMTYPE == "TYPE 7" ~ "TYPE 4",
    RMTYPE == "TYPE 12" ~ "TYPE 5",
    RMTYPE == "TYPE 11" ~ "TYPE 6",
    RMTYPE == "TYPE 13" ~ "TYPE 7",
    RMTYPE == "TYPE 11F" ~ "TYPE 8",
    RMTYPE == "TYPE 13B" ~ "TYPE 9",
    RMTYPE == "Oolitic" ~ "TYPE 10",
    RMTYPE == "TYPE GB" ~ "TYPE 11",
    .default = RMTYPE)) %>% 
  select(AREA, ID, RMTYPE, SUBTYPE, WEIGHT, CORTEXTHICKNESS, CORTEXAPPEARANCE) %>%
  distinct(ID, .keep_all = TRUE)

context <- context %>%
  dplyr::rename("UNIT" = "Unit") %>% # Renaming first column from Unit to UNIT to use cols_to_concat
  unite(col='ID', cols_to_concat_terrace, sep="-", remove=FALSE) %>% # Unite UNIT with ID using cols_to_concat
  select(ID, Level, Spit, Code) %>% # Selecting important variables: ID refers to artifact ID; Level refers to archaeologycal layer; Spit refers to artificial levels within an archaeological layer; Code refers to type of artifact (e.g., LITHIC or BONE)
  distinct(ID, .keep_all = TRUE)

xyz <- xyz %>%
  unite(col='ID', cols_to_concat_terrace, sep="-", remove=FALSE) %>% # Unite UNIT with ID using cols_to_concat
  filter(Suffix == 0) %>% # To avoid several entries related to several points of the same artefact
  select(ID, X, Y, Z) %>% # Selecting important variables
  distinct(ID, .keep_all = TRUE)

field_data <- full_join(xyz, context, by = "ID") # Join field tables

terrace_tech_WIP <- left_join(terrace_tech, field_data, by = "ID") # Join field and RM type tables
terrace_dataset <- full_join(terrace_tech_WIP, terrace_RM_WIP, by = "ID") # Base 12690
terrace_dataset <- terrace_dataset %>%
  filter(!Level %in% c("3", "4", "4C", "4D")) %>%  # Dropping NAs on the technological class drops dataset to 1651
  drop_na(RMTYPE) %>%  # Dropping NAs on the RM database drops dataset to 3635
  drop_na(CLASS) # Dropping NAs on the technological class drops dataset to 1647
  
# Mutate level 5 to add phases: top of 5 (4E/5) and bottom of 5 (5), following Belmiro et al. (2020).
phase_dataset <- terrace_dataset %>% 
  mutate(Level = case_when(
    Level == 5 & Z > 24.1 ~ "4E/5",
    Level == 5 & Z < 24.1 ~ "5",
    Level == "7C" | Level == 8 ~ "7", # Collapsing samples from Level 7C and Level 8 into 7 to homogenise dataset
    TRUE ~ Level)) %>% # Adding technocomplex name based on the levels
  mutate(Technocomplex = case_when(
    Level == "4E" | Level == "4E/5" | Level == 5 ~ "Proto-Solutrean",
    Level == 6 | Level == 7 ~ "Gravettian"))

```

```{r}
#| label: shelter-solutrean-setup

# Setting up the Terrace dataset
cols_to_concat_shelter <- c("YEAR", "ID") # Concatenate YEAR and ID variables in one single variable (e.g. 05-500)

solutrean_WIP <- solutrean_JC %>% 
  filter(Layer %in% c("A", "B", "C")) %>% # Filtering Solutrean layers
  filter(Raw.material %in% c("Chert", "Chalcedony")) %>% # Filtering raw materials
  filter(Screen != "Crivo") %>%  # Filtering out all bucket lithics since they were not included in the RM analysis
  mutate_at("Date", str_replace, "20", "") %>% # Removing initial part of the year to match IDs
  dplyr::rename("YEAR" = "Date") %>% 
  tidyr::unite(col='ID', all_of(cols_to_concat_shelter), sep="-", remove=FALSE) # Concatenate YEAR and ID variables in one single variable (e.g. 05-500)

# Dataset filtering for chert/chalcedony and levels (A-C), 3298 + 61 solutrean points, n=3359
solutrean_original_chert <- solutrean_JC %>% 
  filter(Layer %in% c("A", "B", "C")) %>% # Filtering Solutrean layers
  filter(Raw.material %in% c("Chert", "Chalcedony"))

# In Cascalheira 2010 Retouched piece was not a category but a variable. To match the other DBs, this category was added
solutrean_WIP <- solutrean_WIP %>% 
  mutate(Class = case_when( # This alteration is being done on the original class column
    Retouched == "Yes" ~ "Retouched piece", # Whenever retouch is present, class is now Retouched piece
    TRUE ~ Class)) %>% 
  mutate(CLASS = case_when( # Creating a column for clustered classes, to match the other DBs
    Class == "Blade" | Class == "Bladelet" ~ "ElongBlank", # Cluster blades with bladelets. The distinction can come later through a mutate and the measurements
    Class == "Core front" | Class == "Core tablet" | Class == "Core trimming elem." | Class == "Crested piece" ~ "CorePrepProd", # Cluster all preparation products
    Class == "Fragment" ~ "Shatter",
    Class == "Flake distal frag." | Class == "Flake mesial frag." | Class == "Flake prox. frag." ~ "FlakeFrag", # Cluster flake frags into a single category
    Class == "Blade distal frag." | Class == "Blade mesial frag." | Class == "Blade prox. frag." 
    | Class == "Bladelet distal frag." | Class == "Bladelet mesial frag." | Class == "Bladelet prox. frag." ~ "ElongBlankFrag", # Cluster elong frags into a single category
    TRUE ~ Class)) %>% 
  mutate(COREPREPPROD = case_when( # Creating a column for the types of core preparation and maintenance products (COREPREPPROD)
    Class == "Core front" ~ "Core front",
    Class == "Core tablet" ~ "Core tablet",
    Class == "Core trimming elem." ~ "Core trim",
    Class == "Crested piece" ~ "Crested piece")) %>% 
  mutate(PIECECOMPLETENESS = case_when( # Creating a column for the portions present in flake or elongblank fragments to match other DBs
    Class == "Flake distal frag." | Class == "Blade distal frag." | Class == "Bladelet distal frag." ~ "Distal",
    Class == "Flake mesial frag." | Class == "Blade mesial frag." | Class == "Bladelet mesial frag." ~ "Mesial",
    Class == "Flake prox. frag." | Class == "Blade prox. frag." | Class == "Bladelet prox. frag." ~ "Proximal")) %>% 
  rename(PLATFORMTYPE = Platform_type) %>% # Renaming column
  mutate(PLATFORMTYPE = case_when( # Renaming variables to match correspondent variables in the other DBs
    PLATFORMTYPE == "Multifacetted" ~ "Faceted",
    PLATFORMTYPE == "Unfacetted" ~ "Plain",
    TRUE ~ PLATFORMTYPE)) %>%
  mutate(Type = case_when( # Translating retouched types from Zilhão 1997 to simplified typologies
    Type == "92b" ~ "Retouched piece fragment",
    Type == "92a" ~ "Retouched blank",
    Type == "76" ~ "Splintered piece",
    Type == "75" ~ "Denticulate",
    Type == "74" ~ "Notch",
    Type == "66" ~ "Retouched blade",
    Type == "61" ~ "Truncation",
    Type == "28" ~ "Burin",
    Type == "7" | Type == "5b" | Type == "4"  ~ "Endscrapper",
    TRUE ~ Type)) %>%
  rename(LEVEL = Layer, UNIT = Unit, CORTEX = Percent_of_cortex, CORTEXLOCATION = Loc_of_cortex, THICKNESS = Thickness,
         MAXWIDTH = Width, LENGTH = Length, COREPLATFORM = Core_platfform, SCARCOUNT = N_of_Scars, COREABANDON = Core_abandon,
         RETOUCHEDPIECETYPOLOGY = Type)  # Renaming column
  
solutrean_tech <- solutrean_WIP %>%
  dplyr::select(ID, CLASS, LEVEL, UNIT, COREPREPPROD, PIECECOMPLETENESS, CORTEX, CORTEXLOCATION, PLATFORMTYPE,
                SCARCOUNT, THICKNESS, MAXWIDTH, LENGTH, COREPLATFORM, COREABANDON, RETOUCHEDPIECETYPOLOGY)

solutrean_points <- solutrean_points %>% 
  mutate_at("YEAR", str_replace, "20", "") %>% # Removing initial part of the year to match IDs
  tidyr::unite(col='ID', all_of(cols_to_concat_shelter), sep="-", remove=TRUE)
  
solutrean_tech <- bind_rows(solutrean_tech, solutrean_points) # Uniting technology dataset with points (2167 to 2228)

solutrean_tech <- solutrean_tech %>% # Originally 2228
  distinct(ID, .keep_all = TRUE) # Keeping individual IDs to avoid buckets (down to 1993)

shelter_RM_WIP <- shelter_RM %>%
  mutate_at("ID", str_replace, "VB", "") %>% # Remove "VB" from ID
  mutate(RMTYPE = case_when(
    RMTYPE == "Type 2" ~ "TYPE 2",
    RMTYPE == "Chalcedony" ~ "TYPE 1", # Altering first group names to final group names. Subtypes are maintained as before.
    RMTYPE == "TYPE 15" ~ "TYPE 3",
    RMTYPE == "TYPE 7" ~ "TYPE 4",
    RMTYPE == "TYPE 12" ~ "TYPE 5",
    RMTYPE == "TYPE 11" ~ "TYPE 6",
    RMTYPE == "TYPE 13" ~ "TYPE 7",
    RMTYPE == "TYPE 11F" ~ "TYPE 8",
    RMTYPE == "TYPE 13B" ~ "TYPE 9",
    RMTYPE == "Oolitic" ~ "TYPE 10",
    RMTYPE == "TYPE GB" ~ "TYPE 11",
    RMTYPE == "ND_A" ~ "INDET",
    .default = RMTYPE)) %>%
  select(AREA, ID, RMTYPE, SUBTYPE, WEIGHT, CORTEXTHICKNESS, CORTEXAPPEARANCE) %>%  # Select variables
  distinct(ID, .keep_all = TRUE) # Keeping individual IDs to avoid buckets

solutrean_dataset <- full_join(solutrean_tech, shelter_RM_WIP, by = "ID") # The complete dataset has 2818 (44 points) entries
solutrean_dataset <- solutrean_dataset %>%
  drop_na(RMTYPE) %>%   # Dropping NAs on the RM database drops dataset to 1514
  drop_na(CLASS) # Dropping NAs on the technological class drops dataset to 914
  
```

```{r}
#| label: general-tables

# Tables with class by raw material type (n and %)
## For Gravettian
gravettian_general <- phase_dataset |>
  filter(Level %in% c(6, 7)) |>
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10", "TL", "INDET"))) |>
  tabyl(CLASS, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front")

## For Proto-Solutrean (4E and top of 5)
proto_general <- phase_dataset |> 
  filter(Level %in% c("4E", "4E/5")) |> 
  filter(CLASS != "Chip") |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10", "TL", "INDET"))) |> 
  tabyl(CLASS, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front")

## For Solutrean
solutrean_general <- solutrean_dataset |> 
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10", "TYPE 11", "TL", "INDET"))) |> 
  tabyl(CLASS, RMTYPE) |> 
  adorn_totals(c("row", "col")) |> 
  adorn_percentages("col") |> 
  adorn_pct_formatting(2) |> 
  adorn_ns("front")

```

```{r}
#| label: stats-setup

# Scatterplots for width and length and Boxplots for weight by assemblage

# Solutrean statistics
# DS preparation
solutrean_stats <- solutrean_dataset %>% 
  filter(RMTYPE != "INDET") %>%
   mutate(CLASS = case_when(
    CLASS == "Thinning flake" ~ "ThinningFlake",
    CLASS == "ElongBlank" ~ "ElongatedProd",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    CLASS == "Retouched piece" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "BlankFragProx", # To add proximal fragments to ratio
    TRUE ~ CLASS))

# Scatterplot for width and length
solutrean_scatter <- solutrean_stats |>
  filter(CLASS %in% c("Flake","ElongatedProd", "Core", "RetouchedPiece")) |>
  filter(MAXWIDTH !="0" & LENGTH != "0" & !RMTYPE %in% c("INDET","GB","TL")) |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    RMTYPE == "TYPE 11" ~ "T11",
    TRUE ~ RMTYPE)) |>
   mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10", "T11"))) |>
  mutate(CLASS = factor(CLASS, levels = c("Flake", "ElongatedProd", "Core", "RetouchedPiece"))) |>
  ggplot(aes(x = LENGTH, y = MAXWIDTH, colour = RMTYPE)) +
  geom_point(alpha = 0.9, size = 3) +
  facet_wrap(~CLASS) +
  labs(x="Length (mm)", y="Max. Width (mm") +
  scale_colour_manual(values = c("#8B7B8B", "#FFE1FF", "#EED2EE", "#D8BFD8",
                              "#CDB5CD", "#2B4F60" , "#4A708B", "#798777",
                            "#9FB6CD", "#BDD2B6", "#BDC7C9"))

# Boxplot for individual measurements
# Weight
solutrean_stats_weight <- solutrean_stats %>%
  filter(CLASS %in% c("Flake", "ElongatedProd", "Core", "RetouchedPiece")) %>% 
  filter(WEIGHT !="0" & !RMTYPE %in% c("INDET","GB","TL")) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10", "TYPE 11", "TL"))) %>%
  mutate(CLASS = factor(CLASS, levels = c("Flake", "ElongatedProd", "Core", "RetouchedPiece"))) %>%
  ggplot(aes(RMTYPE, WEIGHT, fill = RMTYPE)) +
  geom_boxplot(aes(fill=factor(RMTYPE)), outlier.shape=21) +
  facet_wrap(~CLASS) +
  stat_summary(fun.y=mean, geom="point", shape=23) +
  labs(x="Raw material types" ,y="Weight (gr)") +
  coord_cartesian(ylim =  c(0, 50)) +
  scale_fill_manual(values = c("#8B7B8B", "#FFE1FF", "#EED2EE", "#D8BFD8",
                              "#CDB5CD", "#2B4F60" , "#4A708B", "#798777",
                            "#9FB6CD", "#BDD2B6", "#BDC7C9")) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# Proto-Solutrean statistics
# DS prep
proto_stats <- phase_dataset %>% 
  filter(Level %in% c("4E", "4E/5")) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "BlankFragProx", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>%
  mutate(elong = MAXWIDTH*2-LENGTH) %>%
  mutate(CLASS = case_when(
    CLASS == "Blank" & elong > 0 ~ "Flake", # QUESTION: do I keep flakes and elong separate or join into blanks?
    CLASS == "Blank" & elong <= 0 ~ "ElongatedProd",
    TRUE ~ CLASS))

# Scatterplots for width and length
proto_scatter <- proto_stats |>
  filter(CLASS %in% c("Flake","ElongatedProd", "Core", "RetouchedPiece")) |>
  filter(MAXWIDTH !="0" & LENGTH != "0" & !RMTYPE %in% c("INDET","GB","TL")) |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    TRUE ~ RMTYPE)) |>
   mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10"))) |>
  mutate(CLASS = factor(CLASS, levels = c("Flake", "ElongatedProd", "Core", "RetouchedPiece"))) |>
  ggplot(aes(x = LENGTH, y = MAXWIDTH, colour = RMTYPE)) +
  geom_point(alpha = 0.9, size = 3) +
  facet_wrap(~CLASS) +
  labs(x="Length (mm)", y="Max. Width (mm") +
  scale_colour_manual(values = c("#8B7B8B", "#FFE1FF", "#EED2EE", "#D8BFD8",
                              "#CDB5CD", "#2B4F60" , "#4A708B", "#798777",
                            "#9FB6CD", "#BDD2B6"))

# Boxplots weight
proto_stats_weight <- proto_stats %>%
  filter(CLASS %in% c("Flake","ElongatedProd", "Core", "RetouchedPiece")) %>% 
  filter(WEIGHT !="0" & !RMTYPE %in% c("INDET","GB","TL")) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10"))) %>%
  mutate(CLASS = factor(CLASS, levels = c("Flake", "ElongatedProd", "Core", "RetouchedPiece"))) %>%
  ggplot(aes(RMTYPE, WEIGHT, fill = RMTYPE)) +
  geom_boxplot(aes(fill=factor(RMTYPE)), outlier.shape=21) +
  facet_wrap(~CLASS) +
  stat_summary(fun.y=mean, geom="point", shape=23) +
  labs(x="Raw material types", y="Weight (gr)") +
  coord_cartesian(ylim =  c(0, 50)) +
  scale_fill_manual(values = c("#8B7B8B", "#FFE1FF", "#EED2EE", "#D8BFD8",
                              "#CDB5CD", "#2B4F60" , "#4A708B", "#798777",
                            "#9FB6CD", "#BDD2B6")) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())


# Gravettian statistics
# DS prep
gravettian_stats <- phase_dataset %>%
  filter(Level %in% c(6, 7)) %>%
  filter(RMTYPE != "INDET") %>%
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "BlankFragProx", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  mutate(elong = MAXWIDTH*2-LENGTH) %>%
  mutate(CLASS = case_when(
    CLASS == "Blank" & elong > 0 ~ "Flake", # QUESTION: do I keep flakes and elong separate or join into blanks?
    CLASS == "Blank" & elong <= 0 ~ "ElongatedProd",
    TRUE ~ CLASS))

# Scatterplots for width and length
gravettian_scatter <- gravettian_stats |>
  filter(CLASS %in% c("Flake","ElongatedProd", "Core", "RetouchedPiece")) |>
  filter(MAXWIDTH !="0" & LENGTH != "0" & !RMTYPE %in% c("INDET","GB","TL")) |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    TRUE ~ RMTYPE)) |>
   mutate(RMTYPE = factor(RMTYPE, levels = c("T1", "T2", "T3", "T4", "T5", "T6","T7", 
                                        "T8", "T9", "T10"))) |>
  mutate(CLASS = factor(CLASS, levels = c("Flake", "ElongatedProd", "Core", "RetouchedPiece"))) |>
  ggplot(aes(x = LENGTH, y = MAXWIDTH, colour = RMTYPE)) +
  geom_point(alpha = 0.9, size = 3) +
  facet_wrap(~CLASS) +
  labs(x="Length (mm)", y="Max. Width (mm") +
  scale_colour_manual(values = c("#8B7B8B", "#FFE1FF", "#EED2EE", "#D8BFD8",
                              "#CDB5CD", "#2B4F60" , "#4A708B", "#798777",
                            "#9FB6CD", "#BDD2B6"))

# Boxplots
# Weight
gravettian_stats_weight <- gravettian_stats %>%
  filter(CLASS %in% c("Flake","ElongatedProd", "Core", "RetouchedPiece")) %>% 
  filter(WEIGHT !="0" & !RMTYPE %in% c("INDET","GB","TL")) %>%
  mutate(RMTYPE = factor(RMTYPE, levels = c("TYPE 1","TYPE 2", "TYPE 3", "TYPE 4",
                                        "TYPE 5", "TYPE 6","TYPE 7", 
                                        "TYPE 8", "TYPE 9", "TYPE 10", "TYPE 11", "TL"))) %>%
  mutate(CLASS = factor(CLASS, levels = c("Flake","ElongatedProd", "Core", "RetouchedPiece"))) %>%
  ggplot(aes(RMTYPE, WEIGHT, fill = RMTYPE)) +
  geom_boxplot(aes(fill=factor(RMTYPE)), outlier.shape=21) +
  facet_wrap(~CLASS) +
  stat_summary(fun.y=mean, geom="point", shape=23) +
  labs(x= "Raw material types", y="Weight (gr)") +
  coord_cartesian(ylim =  c(0, 60)) +
  scale_fill_manual(values = c("#8B7B8B", "#FFE1FF", "#EED2EE", "#D8BFD8",
                              "#CDB5CD", "#2B4F60" , "#4A708B", "#798777",
                            "#9FB6CD", "#BDD2B6")) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```


```{r}
#| label: tool-diversity

# Solutrean table
## Table preparation
solutrean_retouch <- solutrean_dataset |>
    mutate(CLASS = case_when(
    CLASS == "Retouched piece" ~ "RetouchedPiece",
    CLASS == "Retouched piece fragment" ~ "RetouchedPieceFrag",
    TRUE ~ CLASS)) |>
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) |>
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY) |>
  filter(RETOUCHEDPIECETYPOLOGY != "") |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    RMTYPE == "TYPE 11" ~ "T11",
    TRUE ~ RMTYPE))
## Janitor tabyl for final table with n and %
solutrean_retouch_tab <- solutrean_retouch |>
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) |>
  adorn_totals(c("row", "col")) |>
  adorn_percentages("col") |>
  adorn_pct_formatting(2) |> 
  adorn_ns("front")
## Cleaning final table
solutrean_retouch_tab <- solutrean_retouch_tab |> # Replace 0% values with -
  dplyr::mutate(T1 = case_when(T1 == "0   (0.00%)" ~ "-", TRUE ~ T1)) |>
  dplyr::mutate(T2 = case_when(T2 == "0   (0.00%)" ~ "-", TRUE ~ T2)) |>
  dplyr::mutate(T5 = case_when(T5 == "0   (0.00%)" ~ "-", TRUE ~ T5)) |>
  dplyr::mutate(T6 = case_when(T6 == "0   (0.00%)" ~ "-", TRUE ~ T6)) |>
  dplyr::mutate(T7 = case_when(T7 == "0   (0.00%)" ~ "-", TRUE ~ T7)) |>
  dplyr::mutate(T8 = case_when(T8 == "0   (0.00%)" ~ "-", TRUE ~ T8)) |>
  dplyr::mutate(T11 = case_when(T11 == "0   (0.00%)" ~ "-", TRUE ~ T11)) |>
  dplyr::mutate(INDET = case_when(INDET == "0   (0.00%)" ~ "-", TRUE ~ INDET)) |>
  select(RETOUCHEDPIECETYPOLOGY, T1, T2, T5, T6, T7, T8, T11, INDET, Total) # Ordering values

# Proto-solutrean table
## Table preparation
proto_retouch <- phase_dataset |>
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) |>
  filter(Level %in% c("4E", "4E/5")) |>
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY) |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    RMTYPE == "TYPE 11" ~ "T11",
    TRUE ~ RMTYPE))
## Janitor tabyl for final table with n and %
proto_retouch_tab <- proto_retouch %>%
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) %>%
  adorn_totals(c("row", "col")) %>% 
  adorn_percentages("col") %>% 
  adorn_pct_formatting(2) %>% 
  adorn_ns("front")
## Cleaning final table
proto_retouch_tab <- proto_retouch_tab |> # Replace 0% values with -
  dplyr::mutate(T1 = case_when(T1 == "0   (0.00%)" ~ "-", TRUE ~ T1)) |>
  dplyr::mutate(T2 = case_when(T2 == "0   (0.00%)" ~ "-", TRUE ~ T2)) |>
  dplyr::mutate(T3 = case_when(T3 == "0   (0.00%)" ~ "-", TRUE ~ T3)) |>
  dplyr::mutate(T4 = case_when(T4 == "0   (0.00%)" ~ "-", TRUE ~ T4)) |>
  dplyr::mutate(T5 = case_when(T5 == "0   (0.00%)" ~ "-", TRUE ~ T5)) |>
  dplyr::mutate(T6 = case_when(T6 == "0   (0.00%)" ~ "-", TRUE ~ T6)) |>
  dplyr::mutate(T7 = case_when(T7 == "0   (0.00%)" ~ "-", TRUE ~ T7)) |>
  dplyr::mutate(T8 = case_when(T8 == "0   (0.00%)" ~ "-", TRUE ~ T8)) |>
  dplyr::mutate(T9 = case_when(T9 == "0   (0.00%)" ~ "-", TRUE ~ T9)) |>
  dplyr::mutate(TL = case_when(TL == "0   (0.00%)" ~ "-", TRUE ~ TL)) |>
  dplyr::mutate(INDET = case_when(INDET == "0   (0.00%)" ~ "-", TRUE ~ INDET))

# Gravettian table
## Table preparation
gravettian_retouch <- phase_dataset %>% 
  filter(CLASS %in% c("RetouchedPiece", "RetouchedPieceFrag")) %>%
  filter(Level %in% c(6, 7)) %>% 
  select(RMTYPE, RETOUCHEDPIECETYPOLOGY) %>% 
  dplyr::group_by(RMTYPE) |>
  dplyr::mutate(RMTYPE = case_when(
    RMTYPE == "TYPE 1" ~ "T1",
    RMTYPE == "TYPE 2" ~ "T2",
    RMTYPE == "TYPE 3" ~ "T3",
    RMTYPE == "TYPE 4" ~ "T4",
    RMTYPE == "TYPE 5" ~ "T5",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    TRUE ~ RMTYPE))
## Janitor tabyl for final table with n and %
gravettian_retouched_tab <- gravettian_retouch %>% 
  tabyl(RETOUCHEDPIECETYPOLOGY, RMTYPE) %>%
  adorn_totals(c("row", "col")) %>% 
  adorn_percentages("col") %>% 
  adorn_pct_formatting(2) %>% 
  adorn_ns("front")
## Cleaning final table
gravettian_retouched_tab <- gravettian_retouched_tab |> # Replace 0% values with -
  dplyr::mutate(T1 = case_when(T1 == "0   (0.00%)" ~ "-", TRUE ~ T1)) |>
  dplyr::mutate(T2 = case_when(T2 == "0   (0.00%)" ~ "-", TRUE ~ T2)) |>
  dplyr::mutate(T3 = case_when(T3 == "0   (0.00%)" ~ "-", TRUE ~ T3)) |>
  dplyr::mutate(T4 = case_when(T4 == "0   (0.00%)" ~ "-", TRUE ~ T4)) |>
  dplyr::mutate(T5 = case_when(T5 == "0   (0.00%)" ~ "-", TRUE ~ T5)) |>
  dplyr::mutate(T6 = case_when(T6 == "0   (0.00%)" ~ "-", TRUE ~ T6)) |>
  dplyr::mutate(T7 = case_when(T7 == "0   (0.00%)" ~ "-", TRUE ~ T7)) |>
  dplyr::mutate(T8 = case_when(T8 == "0   (0.00%)" ~ "-", TRUE ~ T8)) |>
  dplyr::mutate(T9 = case_when(T9 == "0   (0.00%)" ~ "-", TRUE ~ T9)) |>
  dplyr::mutate(T10 = case_when(T10 == "0   (0.00%)" ~ "-", TRUE ~ T10)) |>
  dplyr::mutate(TL = case_when(TL == "0   (0.00%)" ~ "-", TRUE ~ TL)) |>
  dplyr::mutate(INDET = case_when(INDET == "0   (0.00%)" ~ "-", TRUE ~ INDET)) |>
  select(RETOUCHEDPIECETYPOLOGY, T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, TL, INDET, Total) # Ordering values

```

## Gravettian (levels 6-7)

The sample studied for the Gravettian occupation (>2012 excavations) of the Terrace area included 766 artifacts. When crossing the lithic class with chert type, we see that the local cherts show similar patterns, with T2 and T5 being the types with higher numbers of artefacts (n=110 and n=72, respectively). For all local cherts, blanks represent more than 50% of the artefacts. Cores and core maintenance products are only present in T2 and T5, although in small frequencies: for T2, cores represent 13.6% of the group and core preparation and maintenance products represent 1.8% (n=2). For T5 only 4 core fragments and 1 core preparation and maintenance product are present. Retouched tools seem to be especially relevant in T2 (~18%), being the most frequent class after blanks. The presence of burin spalls (8.1%) in T2 is expected due to the prevalence of burins (see below). In comparison, T5 shows similar percentages of retouched tools and shatter (~12% and ~14%, respectively). T1 (chalcedony) shows similar patterns, although with higher percentages of shatter (34.3%). In comparison, non-local chert types (especially T6 with n=169 and T7 with n=86) show similar percentages of blanks (~40-50%) but higher percentages of retouched tools (~30%). Cores, core fragments and core preparation and maintenance products are also present even if in small percentages (<4%), as well as shatter (~12%). In both chert types burin spalls are also present (7.1% for T6 and 4.6% for T7). The TL cherts show, as expected, blanks and blank fragments (n=3 and n=2, respectively), and retouched tools (n=4). The presence of core maintenance products in TL is possibly related to the limited knapping of TL01 (jasper).

```{r}
#| label: tbl-general-gravettian
#| tbl-cap: Number and percentage of technotypological classes by raw material type from the Gravettian assemblage (levels 6 and 7) of the Terrace area of Vale Boi.

kable(gravettian_general)

```

As seen in table **, 170 retouched tools were identified, with 22.9% (n=39) having an unidentified chert type. From the identified chert types, 24.1% of retouched tools are from local types and 52.9% from non-local cherts. Regarding typologies, 15 types of retouched tools were identified (excluding retouched tool fragments). All these typologies were found in the non-local chert group, while only 7 retouched tool typologies were identified in local cherts/chalcedony. The most common typologies identified in the assemblage were burins (n=52), endscrappers (n=17), retouched flakes (n=30) and splintered pieces (n=26). From all these, the majority were produced in non-local chert, mainly T6 and in lesser numbers T7. Although in lesser numbers as well, backed bladelets were also identified (n=6), but only present in non-local chert types (T6 and T7).

```{r}
#| label: tbl-retouch-gravettian
#| tbl-cap: Number and percentage of retouched tools by raw material of the Gravettian assemblage (levels 6 and 7) of the Terrace area.

kable(gravettian_retouched_tab)
  
```

Regarding the sizes of the lithic artifacts (width, length and weight), blanks (flakes and elongated products) and retouched tools show little differences in the measurements of artefacts of local and non-local chert types. The only exception are T6 and T7 flakes, which show slightly lower weight means (~2.6-3.0 gr) and lower maximum length (~20-22 mm) than the other types. For cores, T2 shows bigger (heavier) values than T6 (means of 21.3 and 12.6, and maximum weight of 37.2 gr and 22.5 gr, respectively), even if they seem to vary in morphology, with little patterns regarding thickness, width and length.

```{r}
#| label: fig-gravettian-boxplots
#| fig-cap: Boxplots Solutrean

gravettian_graphs <- ggpubr::ggarrange(gravettian_scatter, gravettian_stats_weight, labels = c("c1", "c2"), ncol = 2, common.legend = TRUE, legend = "bottom")

```

As mentioned in the methodology, two different ratios were calculated: blank-to-core and tools-to-debitage. In general, non-local chert types show higher values for these ratios. Local types (T1 and T2) show lower ratios (<4) of blanks to cores, although other local types (T3-T5) have no identified cores. The non-local types, especially T6 and T7 show higher ratios (~8) of blanks to cores. T1 to T5 show low ratios (0.25-0.5) of retouched to debitage, while TL and T6-T8 show higher ratios (0.9-1.0). The exception is T10 (non-local type), which shows a lower ratio (0.28), more akin to local cherts.

```{r}
#| label: fig-ratiobc
#| fig-cap: Plotted ratios of blanks-to-core by assemblage and by chert type. All local cherts were grouped in a single category "Local", while non-local cherts maintained their individual IDs.

# DS preparation and tool-to-debitage ratio tables
## For Gravettian
gravettian_ratiobc <- phase_dataset %>% 
  filter(Level %in% c(6, 7)) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Blank/Core" = Blank / Core)

# For Proto-Solutrean
proto_ratiobc <- phase_dataset %>% 
  filter(Level %in% c("4E", "4E/5")) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>%
  mutate("Blank/Core" = Blank / Core)

# For Solutrean
solutrean_ratiobc <- solutrean_dataset %>% 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" | CLASS == "Thinning flake" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    TRUE ~ CLASS)) %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    TRUE ~ CLASS)) %>% 
  filter(RMTYPE != "INDET") %>% 
  filter(CLASS %in% c("Blank", "Core")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Blank/Core" = Blank / Core)

# Cleaning up to create a single table for scatterplot
gravettian_ratiobc_b <-gravettian_ratiobc %>%
  filter(`Blank/Core` != "Inf") %>% 
  dplyr::mutate("Assemblage" = "Gravettian") %>% 
  select(Assemblage, RMTYPE, `Blank/Core`)
proto_ratiobc_b <- proto_ratiobc %>% 
  filter(`Blank/Core` != "Inf") %>% 
  dplyr::mutate("Assemblage" = "Proto-Solutrean") %>% 
  select(Assemblage, RMTYPE, `Blank/Core`)
solutrean_ratiobc_b <- solutrean_ratiobc %>% 
  filter(`Blank/Core` != "Inf") %>% 
  dplyr::mutate("Assemblage" = "Solutrean") %>% 
  select(Assemblage, RMTYPE, `Blank/Core`)
ratio_blankcore <- bind_rows(gravettian_ratiobc_b, proto_ratiobc_b,solutrean_ratiobc_b)

# Scatterplot with local vs non-local RM Types
ratio_blankcore |>
  dplyr::mutate(Source = case_when(
    RMTYPE == "TYPE 1" | RMTYPE == "TYPE 2" | RMTYPE == "TYPE 3" | RMTYPE == "TYPE 4" | RMTYPE == "TYPE 5" ~ "Local",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 9" ~ "T9",
    RMTYPE == "TYPE 10" ~ "T10",
    RMTYPE == "TYPE 11" ~ "T11",
    TRUE ~ RMTYPE)) |>
  mutate(Source = factor(Source, levels = c("Local", "T6","T7", 
                                        "T8", "T9", "T10", "T11", "TL"))) |>
  ggplot(aes(x=Assemblage, y=`Blank/Core`, colour = Source)) +
  geom_point(size=3) +
  coord_cartesian(clip = "off") +
  scale_colour_manual(values = c("#D49B54", "#8B6969", "#CDAF95", "#2B4F60",
                              "#8B7D6B", "#BDD2B6", "#798777", "#BDC7C9"))

```

```{r}
#| label: fig-ratiotd
#| fig-cap: Plotted ratios of tools-to-debitage by assemblage and by chert type. All local cherts were grouped in a single category "Local", while non-local cherts maintained their individual IDs.

# DS preparation and tool-to-debitage ratio tables
## For Gravettian
gravettian_ratiotd <- phase_dataset %>% 
  filter(Level %in% c(6, 7)) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

## For Proto-Solutrean
proto_ratiotd <- phase_dataset %>% 
  filter(Level %in% c("4E", "4E/5")) %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

## For Solutrean
solutrean_ratiotd <- solutrean_dataset %>% 
  filter(RMTYPE != "INDET") %>% 
  mutate(CLASS = case_when(
    CLASS == "Flake" | CLASS == "ElongBlank" | CLASS == "Thinning flake" ~ "Blank",
    CLASS == "FlakeFrag" | CLASS == "ElongBlankFrag" ~ "BlankFrag",
    CLASS == "Retouched piece" ~ "RetouchedPiece",
    CLASS == "Retouched piece fragment" ~ "RetouchedPieceFrag",
    TRUE ~ CLASS)) %>% 
  mutate(CLASS = case_when(
    CLASS == "BlankFrag" & PIECECOMPLETENESS == "Proximal" ~ "Blank", # To add proximal fragments to ratio
    CLASS == "RetouchedPieceFrag" & PIECECOMPLETENESS == "Proximal" ~ "RetouchedPiece",
    TRUE ~ CLASS)) %>% 
  filter(CLASS %in% c("Blank", "RetouchedPiece")) %>% 
  count(RMTYPE, CLASS, sort = TRUE) %>% 
  group_by(RMTYPE, CLASS) %>%
  summarise(n=sum(n)) %>% 
  spread(CLASS, n, fill=0) %>% 
  mutate(sum = rowSums(across(where(is.numeric)))) %>% 
  filter(!sum <= 5) %>% 
  mutate("Tool/Blank" = RetouchedPiece / Blank)

# Creating a single table with all ratios by assemblage for the scatterplot
gravettian_ratiotd_b <-gravettian_ratiotd %>% 
  dplyr::mutate("Assemblage" = "Gravettian") %>% 
  select(Assemblage, RMTYPE, `Tool/Blank`)
proto_ratiotd_b <- proto_ratiotd %>% 
  dplyr::mutate("Assemblage" = "Proto-Solutrean") %>% 
  select(Assemblage, RMTYPE, `Tool/Blank`)
solutrean_ratiotd_b <- solutrean_ratiotd %>% 
  dplyr::mutate("Assemblage" = "Solutrean") %>% 
  select(Assemblage, RMTYPE, `Tool/Blank`)
ratio_tooldebitage <- bind_rows(gravettian_ratiotd_b, proto_ratiotd_b,solutrean_ratiotd_b)

# Scatterplot with local vs non-local RM Types
ratio_tooldebitage |>
  dplyr::mutate(Source = case_when(
    RMTYPE == "TYPE 1" | RMTYPE == "TYPE 2" | RMTYPE == "TYPE 3" | RMTYPE == "TYPE 4" | RMTYPE == "TYPE 5" ~ "Local",
    RMTYPE == "TYPE 6" ~ "T6",
    RMTYPE == "TYPE 7" ~ "T7",
    RMTYPE == "TYPE 8" ~ "T8",
    RMTYPE == "TYPE 10" ~ "T10",
    RMTYPE == "TYPE 11" ~ "T11",
    TRUE ~ RMTYPE)) |>
  mutate(Source = factor(Source, levels = c("Local", "T6","T7", 
                                        "T8", "T9", "T10", "T11", "TL"))) |>
  ggplot(aes(x=Assemblage, y=`Tool/Blank`, colour = Source)) +
  geom_point(size=3) +
  scale_colour_manual(values = c("#D49B54", "#8B6969", "#CDAF95", "#2B4F60",
                              "#8B7D6B", "#BDD2B6", "#798777", "#BDC7C9"))

```

## Proto-Solutrean (levels 4E and top of level 5)

The final lithic sample from the Proto-Solutrean assemblage, consisting of the levels 4E and top of level 5, consists of 635 artifacts. When crossing the lithic class with chert type, we see that the local types show high frequency of blanks (>50%, including blank fragments), followed by shatter (~11-27%), cores (~9-12%) and retouched tools (~5-15%). A single burin spall was identified in T4. There is also the absence of core preparation and maintenance products across all local cherts. T1 (chalcedony) is composed mostly of blanks and a retouched tool (Vale Comprido point). The absence of cores but presence of shatter may hint at the knapping of this raw material at the site, but the absence of formal cores perhaps due to the quality of nodules/lenses, which are characterised by fractures. For non-local types, especially those with higher number of artefacts (T6-T8), blanks and blank fragments are the most frequent class (48.3%, 53.1% and 69.2%, respectively). Retouched tools are present in smaller frequencies for the previous mentioned chert types (~17-23%). For T6 the absence of cores but the presence of shatter and a single core preparation and maintenance product suggests knapping on site. Similarly, T7 shows the presence of cores and core fragments (8.4%), shatter (17.0%) and a single core preparation and maintenance product. In comparison, T8, despite more limited in number (n=13), shows only one core, with the rest of the artefacts being blanks (as previously noted) or retouched tools (23.1% and n=3). Aside from the TL artefacts, all non-local cores show at least 1 core and frequently the presence of shatter. As expected, the TL artifacts include a blank and a retouched. However, a shatter was also identified.
In total, 65 chert retouched tools were identified, with 23.1% (n=15) having an unidentified chert type. A total of 26 retouched tools correspond to local cherts, while 23 correspond to non-local cherts.

```{r}
#| label: tbl-general-proto
#| tbl-cap: Number and percentage of technotypological classes by raw material type from the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area of Vale Boi.

kable(proto_general)

```

Regarding the typology, 14 different types of retouched tools were identified. Endscrappers (26.2%), splintered pieces (17%), burins (12.3%) and retouched flakes (7.7%) were the most prevalent. Vale Comprido points, the Proto-Solutrean fossil director, are barely present in chalcedony and chert (n=1), as they are mostly present in dolerite, while chert was mainly used for other tools as seen in previous studies (Belmiro et al., 2021). Regarding the types of chalcedony and chert, local raw materials show 9 different typologies, with Vale Comprido points, Solutrean retouch and notches being present only in the local types, even if in small numbers. Non-local cherts show 10 different typologies of retouched tools. Perforator-endscrapper, truncation, backed bladelet and retouched blades typologies can only be found in non-local varieties, albeit also in small numbers.

```{r}
#| label: tbl-retouch-proto
#| tbl-cap: Number and percentage of retouched tools by raw material of the Proto-Solutrean assemblage (levels 4E and top of level 5) of the Terrace area.

kable(proto_retouch_tab)

```

Regarding the debitage, cores and tool sizes, flakes show slightly higher means in local cherts (~21-22 mm for length and 3.5-4.5 gr for weight), in comparison to non-local cherts, especially T6-T8 (~19-20 mm for length and 1.3-2.6 gr in weight), with exception of chalcedony which shows consistently low sizes (21.8 mm for length and 2.8 gr for weight). Elongated blank however, show no differences between local and non-local chert types. In retouched tools, weight also shows smaller means for non-local cherts (~3-2 gr), although with higher standard deviation (~1.6). Regarding cores, the sample size for non-local cherts is small and only T7 statistics could be obtained. Despite this, when compared to local cherts (T2-T5), T7 cores show smaller mean and maximum values (7.3 gr and 8 gr, respectively).

```{r}
#| label:  fig-proto-boxplots
#| fig-cap: Boxplots Proto-Solutrean

proto_graphs <- ggpubr::ggarrange(proto_scatter, proto_stats_weight, labels = c("b1", "b2"), ncol = 2, common.legend = TRUE, legend = "bottom")

```

Similar to the Gravettian, non-local cherts seem to show the highest values in the calculated blank-to-core and tool-to-debitage ratios. T2 and T4 show the lowest ratios (8.7 and 6.2 respectively) of blanks per cores, while the non-local T7 shows the highest ratios (11.0) of blanks to cores. Unlike the Gravettian, T1 (local chalcedony) and T6 (non-local chert) have no cores. The lowest ratio of retouched to debitage is seen in T1 and T4, with values below 0.1, while other local types show slightly higher values (0.1-0.2). Following the same trend as the Gravettian, the non-local cherts show slightly higher ratios (0.3-0.5) of retouched to debitage.

## Solutrean (levels A to C)

The Solutrean assemblages show similar patterns to those observed in previous assemblages. The final sample from levels A, B and C from the Solutrean occupations of the Shelter area consists of 914 artifacts. When crossing the class data with type of raw material, we see that local chert, especially T2 (n=506) which accounts for the majority of local chert present in the studied samples, the majority of the debitage is composed of flakes and elongated blanks (83.9%). Cores are also present (10.5%), alongside a small percentage of core preparation and maintenance products (1.3%). In comparison to debitage products, retouched tools are scarce in the sample (~3%). The non-local cherts most present in the Solutrean of the Shelter area are T6 (n=86) and T8 (n=30). These show similar patterns to the local cherts, with high percentages of blanks (>50%). Cores and core preparation and maintenance are also present in small percentages (~3-6% and 3.5% only for T6, respectively), as well as retouched tools (<10%). However, these specific results are truncated by the lack of shatter, which were not present in the sample used for the study (see Materials and Methods section). It is important to notice, however, that alike previous results from the Solutrean assemblages of the Terrace area, a large portion of the studied sample was altered and did not allow for a chert type attribution (21.9912473%).

```{r}
#| label: tbl-general-solutrean
#| tbl-cap: Number and percentage of technotypological classes by raw material type from the Solutrean assemblage (levels A to C) of the Shelter area of Vale Boi.

kable(solutrean_general)

```

The analysed Solutrean sample has a total of 43 retouched tools (complete and fragments), with a high variety of retouched tools (11), ranging from 5 (11.6%) to 4 (9.3%) per tool type. These results however, are significantly reduced from the original dataset (Cascalheira et al., 2013), possibly due to no bucket coordinates being used. The typologies which are most frequently present in the studied sample are bifacial blanks and bifacial fragments, amounting to a total of 23.2% of products related to bifacial tool/point production. Two types of points were identified: shouldered points (2 complete and 1 fragment, amounting to a total of 6.9%) and tanged and 4 winged points (9.3%). Other frequent retouched typologies are end scrappers (9.3%), notches (11.6%), retouched blanks (~14%) and splintered pieces (11.6%). Regarding chert type, a substantial portion of retouched tools are of unidentified chert types (n=13), mostly due to alterations (fire and post depositional). Most retouched tools with identified chert are local (n=13, accounting to 30.2325581%), followed by Type 6 cherts, previously suggested to be from Central Portugal (n=7, accounting to 16.2790698%). Local types show a higher variability retouched typologies (9 types), although this may be related to the higher number of tools. In comparison, Type 6 shows only 5 different typologies.

```{r}
#| label: tbl-retouch-solutrean
#| tbl-cap: Number and percentage of retouched tools by raw material of the Solutrean assemblage (level A to C) of the Shelter area.

kable(solutrean_retouch_tab)

```

For the Solutrean assemblage, there seems to be no clear difference in the measurements and weights of artefacts between local and non-local cherts. This is true especially for the most represented classes (flakes and elongated blanks). Regarding cores, many of the local and non-local cherts are not available for the statistics due to missing data. However, the smallest weight mean seem to be for cores of T6 (16.5 gr), although with high standard deviation and maximum value (16.5 and 48.6 gr, respectively).

```{r}
#| label: fig-solutrean-boxplots
#| fig-cap: Boxplots Gravettian.

solutrean_graphs <- ggpubr::ggarrange(solutrean_scatter, solutrean_stats_weight, labels = c("a1", "a2"), ncol = 2, common.legend = TRUE, legend = "bottom")

```

Regarding the blank-to-core and tools-to-debitage ratios, the Solutrean assemblage shows similar patterns as the previous assemblages, with the local cherts showing lower blank to core ratios (<7), while the non-local cherts show higher ratios (>9). Similar to the Proto-Solutrean, chalcedony cores were also not identified in the studied sample. Similarly, local cherts (T2-T5) show low retouch to debitage ratios (<0.1), with the exception of T1 (chalcedony), which shows a ratio of 1.8. Other non-local cherts (T6-T7 and T11) show slightly higher retouch to debitage ratios (0.1-0.3).

# Discussion

Hypotheses to test: a) use lives derived from knapping strategies; b) reduction intensity and tools-to-debitage ratios; c) core size and blank-to-core ratios; d) reduction intensity and tool reworking; e) tool typology diversity and specialization.

To test these hypotheses, the following parameters were evaluated for each assemblage and compared between chert types: P1) frequency of retouched tools; P2) frequency of maintenance products; P3) debitage sizes; P4) tools-to-debitage ratios ; P5) core sizes; P6) blank-to-core ratios; P7) retouched tool sizes; P8) tool diversity; P9) tool specialization. The results may be summarised as follows:

Retouched tools are present in higher percentages in the Gravettian assemblages. Within the assemblage, retouched tools (P1) are present in higher frequencies in the non-local cherts, as well as in core preparation and maintenance products (P2). Debitage sizes (P3) show no differences between local and non-local cherts. Tools-to-debitage ratios (P4) are significantly higher in non-local cherts. Core sizes (P5) are slightly smaller in T6, a non-local chert, and the blank-to-core ratios (P6) are higher in non-local cherts. Alike blanks, retouched sizes (P7) show no relevant differences between local and non-local cherts; however, tool diversity (P8) is higher in non-local cherts, although with high frequency of less specialised tools such as notches and retouched tools, alongside hunting implements such as backed bladelets (P9). The high frequency of burins seen in this assemblage may be related to their use as cores, representing a knapping strategy more than the presence of retouch.

The Proto-Solutrean assemblages show a smaller presence of retouched tools than the Gravettian, and within the assemblage, retouched tools (P1) are slightly more frequent in non-local cherts. Core preparation and maintenance products (P2) are only present in non-local cherts, albeit in very small numbers (n=2). Debitage sizes (P3), core sizes (P5), and retouched tool sizes (P7) are slightly smaller in non-local cherts. Regarding the ratios, tool-to-debitage ratios (P4) are higher in non-local cherts, albeit smaller than those seen in the Gravettian assemblage, and blank-to-core ratios (P6) are also higher in non-local cherts. Little differences were observed in tool diversity (P8) and specialisation (P9) between local and non-local cherts.

Finally, the Solutrean shows no relevant differences in the frequencies of retouched tools (P1) and core preparation and maintenance products (P2) between local and non-local cherts. In general, the retouch frequency is lower than that observed in the previous assemblages. Debitage (P3), core (P5), and retouched tool (P7) sizes show no differences between local and non-local cherts. Similarly to the Proto-Solutrean, tools-to-debitage ratios (P4) and blank-to-core ratios (P6) are slightly higher in non-local cherts. Both tool diversity (P8) and tool specialization (P9) are higher in local cherts.

How the results fit or do not fit within the hypothesis, and possible reasons why.

Focus on the high presence of retouch and burins during the Gravettian.

Fitting the technological data with the suggested interpretations from article 2.

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r}
#| label: colophon
#| cache: false

# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```
